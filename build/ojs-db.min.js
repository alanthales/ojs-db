/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var ArrayMap=function(){"use strict";function t(){var r=[];return r=Array.apply(r,arguments)||r,r.__proto__=t.prototype,r.mapTable=function(t){return this.map(function(e){return e[t]})},r.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},r.put=function(t,e){var n=e||this.length;this[n]=t},r.putRange=function(t,e){var n,r,i=e&&"boolean"==typeof e?this.length:0;if(t)for(t instanceof Array||(t=[t]),r=0,n=t.length;n>r;r++)this.put(t[r],i+r)},r.query=function(n){var r=this,i=n&&"object"==typeof n?n:{},o=new t,a=function(t){return e.call(r,t,i)},s=n&&"function"==typeof n?n:a;return o.putRange(r.filter(s)),o},r.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},r=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(e>t)},i=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(t>e)};return this.sort(function(t,o){var a=0;for(e in n){if(t[e]!=o[e]){a="desc"===n[e]?i(t[e],o[e]):r(t[e],o[e]);break}a=0}return a}),this},r.groupBy=function(r,i,o){var a,s,c,u=this,f=new t,p=o&&"object"==typeof o?o:{},l=i.length,h={};return u.forEach(function(t){if(e.call(u,t,p)){for(s={},c=0;l>c;c++)s[i[c]]=t[i[c]];a=JSON.stringify(s),h[a]=h[a]||[],h[a].push(t)}}),f.putRange(Object.keys(h).map(function(t){return s=JSON.parse(t),n(h[t],r,s)})),f},r.compute=function(t){return n(this,t)},r}var e=function(t,e){var n,r,i,o=!0;for(n in e){if(!o)break;if("object"==typeof e[n]){i=t[n].toString();for(r in e[n]){switch(r){case"$gt":o=t[n]>e[n][r];break;case"$gte":o=t[n]>=e[n][r];break;case"$lt":o=t[n]<e[n][r];break;case"$lte":o=t[n]<=e[n][r];break;case"$not":o=t[n]!=e[n][r];break;case"$start":o=0===i.lastIndexOf(e[n][r],0);break;case"$end":o=-1!==i.indexOf(e[n][r],i.length-e[n][r].length);break;case"$contain":o=i.indexOf(e[n][r])>-1;break;case"$in":o=e[n][r].indexOf(t[n])>-1;break;default:o=!1}if(!o)break}}else o=t[n]==e[n]}return o},n=function(t,e,n){var r,i,o,a=e&&e instanceof Array?e:[e],n=n||{};return a.forEach(function(e){for(r in e)break;switch(i=e[r],o=e.alias||i,r){case"$max":t.sort(function(t,e){return e[i]-t[i]}),n[o]=t[0][i];break;case"$min":t.sort(function(t,e){return t[i]-e[i]}),n[o]=t[0][i];break;case"$sum":n[o]=t.map(function(t){return t[i]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":n[o]=t.map(function(t){return t[i]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),n[o]/=t.length;break;case"$count":n[o]=t.length}}),n};return t.prototype=Object.create(Array.prototype),t}(),OjsUtils=function(){"use strict";var t=function(t){for(var e,n=new Array(t),r=0;t>r;r++)0==(3&r)&&(e=4294967296*Math.random()),n[r]=e>>>((3&r)<<3)&255;return n},e=function(t){function e(t){return o[t>>18&63]+o[t>>12&63]+o[t>>6&63]+o[63&t]}var n,r,i,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,s="";for(i=0,r=t.length-a;r>i;i+=3)n=(t[i]<<16)+(t[i+1]<<8)+t[i+2],s+=e(n);switch(a){case 1:n=t[t.length-1],s+=o[n>>2],s+=o[n<<4&63],s+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],s+=o[n>>10],s+=o[n>>4&63],s+=o[n<<2&63],s+="="}return s};return{uid:function(n){return e(t(Math.ceil(Math.max(8,2*n)))).replace(/[+\/]/g,"").slice(0,n)},cloneObject:function(t){var e,n,r;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?e=new ArrayMap:t instanceof SimpleDataSet?e=new SimpleDataSet:t instanceof ChildRecord&&(e=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(e=e||[],n=0,r=t.length;r>n;n++)e[n]=this.cloneObject(t[n]);return e}if("object"==typeof t){e=e||{};for(n in t)t.hasOwnProperty(n)&&(e[n]=this.cloneObject(t[n]));return e}return t},cloneProperties:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}}}(),ChildRecord=function(){"use strict";function t(t,e){var n=t,r=e;this.getDtsMaster=function(){return n},this.getRecMaster=function(){return r},this.setRecMaster=function(t){t&&(r=t)}}return t.prototype.notifyMaster=function(){this.getDtsMaster().save(this.getRecMaster())},t}(),SimpleDataSet=function(){"use strict";function t(){this._inserteds=[],this._updateds=[],this._deleteds=[],this._copy=null,this._lastOp=null,this.sort=null,this.data=new ArrayMap}t.prototype._cleanCache=function(){this._inserteds.length=0,this._updateds.length=0,this._deleteds.length=0,this._copy=null,this._lastOp=null},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",t);return this.data[e]};var e=function(t,e){this._copy=OjsUtils.cloneObject(e),this._lastOp=t,e instanceof ChildRecord&&e.notifyMaster()};return t.prototype.insert=function(t){t.id||(t.id=(new Date).getTime());var n=this.data.indexOfKey("id",t.id);return-1===n&&(this._inserteds.push(t),this.data.push(t),e.call(this,"insert",t)),this},t.prototype.update=function(t){if(!t.id)return this;var n,r=this.data.indexOfKey("id",t.id);return-1===r?this:(n=this._updateds.map(function(t){return t.id}).indexOf(t.id),-1===n?this._updateds.push(t):this._updateds.splice(n,1,t),e.call(this,"update",this.data[r]),this.data.splice(r,1,t),this)},t.prototype.save=function(t){return t?t.id?this.update(t):this.insert(t):void 0},t.prototype["delete"]=function(t){if(!t.id)return this;var n=this.data.indexOfKey("id",t.id);return n>=0&&(this._deleteds.push(t),e.call(this,"delete",this.data[n]),this.data.splice(n,1)),this},t.prototype.insertAll=function(t){var e=this;return!t instanceof Array?e:(t.forEach(function(t){e.insert(t)}),e)},t.prototype.clear=function(){return this.data.length=0,this._cleanCache(),this},t.prototype.cancel=function(){if(this._copy){var t=this.data.indexOfKey("id",this._copy.id);switch(this._lastOp){case"insert":this.data.splice(t,1),this._inserteds.pop();break;case"update":this.data.splice(t,1,this._copy),this._updateds.pop();break;case"delete":this.data.push(this._copy),this._deleteds.pop()}this._copy=null,this._lastOp=null}},t.prototype.filter=function(t){return this.data.query(t)},t.prototype.forEach=function(t){this.data.forEach(t)},t}(),DataSet=function(){"use strict";function t(t,e,n,r){var i=t,o=e,a=r;this.active=!1,this.limit=1e3,this.params=null,this.genId=n,this.eof=!0,this.reOpenOnRefresh=!1,this.getProxy=function(){return i},this.getTable=function(){return o},this.getSynchronizer=function(){return a},SimpleDataSet.apply(this)}t.prototype=Object.create(SimpleDataSet.prototype);var e=function(t,e){var n=this,r=e&&"function"==typeof e?e:function(){};n.getProxy().getRecords(t,function(t,e){n.data.putRange(e,!0),n.active=t?!1:!0,n.eof=e.length<n.limit,r(t,e)})};return t.prototype.open=function(t){var n={key:this.getTable(),limit:this.limit,sort:this.sort,params:this.params};return this.active?(t&&"function"==typeof t&&t(null,this.data),this):(e.call(this,n,t),this)},t.prototype.next=function(t){var n=this,r={key:n.getTable(),limit:n.limit,sort:n.sort,params:n.params,skip:n.limit},i=t&&"function"==typeof t?t:function(){};return n.eof?(i(null,!1),n):(e.call(n,r,function(t,e){i(t,!n.eof)}),n)},t.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),this.active=!1,this},t.prototype.refresh=function(t){var e=t&&"function"==typeof t?t:function(){};return this.reOpenOnRefresh?(this.active=!1,this.open(e)):(this.sort&&this.data.orderBy(this.sort),e(),this)},t.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.insert.apply(this,arguments)},t.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.update.apply(this,arguments)},t.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype["delete"].apply(this,arguments)},t.prototype.post=function(t,e){function n(t){return t?(r.cancel(),i(t)):(o&&!e&&o.writeData(r.getTable(),r._inserteds,r._updateds,r._deleteds),r.refresh(),r._cleanCache(),void i())}if(!this.active)throw"Invalid operation on closed dataset";var r=this,i="function"==typeof t?t:function(){},o=this.getSynchronizer();return r._inserteds.length||r._updateds.length||r._deleteds.length?void r.getProxy().commit(r.getTable(),r._inserteds,r._updateds,r._deleteds,n):i()},t.prototype.sync=function(t){var e=this,n=this.getSynchronizer(),r=t&&"function"==typeof t?t:function(){};n&&n.exec(e.getTable(),function(t,n,i){function o(t){c.indexOfKey("id",t.id)<0&&e["delete"](t)}function a(t){f.indexOf(t.id)>-1&&e["delete"](t)}if(t)return r(t);if(n=n||[],i=i||[],!n.length&&!i.length)return r();var s,c=new ArrayMap,u=new ArrayMap,f=i.map(function(t){return t.id});c.putRange(n),u.putRange(e.data),s=i&&i instanceof Array?a:o,u.forEach(s),c.forEach(function(t){e.data.indexOfKey("id",t.id)<0?e.insert(t):e.update(t)}),e.post(r,!0)})},t.prototype.fetch=function(t,e){var n=e&&"function"==typeof e?e:function(){};return this.active?(this.getProxy().fetch(this.getTable(),this,t,n),this):(n(),this)},t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1,RESTFUL:2}}(),DbProxy=function(){function t(){this.mappings={}}return t.prototype.createDatabase=function(t,e){this.mappings=t},t.prototype.getRecords=function(t,e){},t.prototype.commit=function(t,e,n,r,i){},t.prototype.fetch=function(t,e,n){},t.dateParser=function(t,e){var n,r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&(n=r.exec(e))?new Date(e):e},t}(),LocalStorageProxy=function(){"use strict";function t(){DbProxy.apply(this,arguments)}var e=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],r=new ArrayMap;return n&&r.putRange(JSON.parse(n,DbProxy.dateParser)),r.length&&t.params?r.query(t.params):r},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var r=e(t);t.sort&&r.orderBy(t.sort),"function"==typeof n&&n(null,r)},t.prototype.query=function(t,n,r){var i=e(t),o=i.query(n);r(null,o)},t.prototype.groupBy=function(t,n,r,i,o){var a=e(t);o(null,a.groupBy(n,r,i))},t.prototype.save=function(t,r,i){var o=e(t),a=o.indexOfKey("id",r.id);-1===a?o.push(r):o.splice(a,1,r),n(t,o,i)},t.prototype.remove=function(t,r,i){var o="object"==typeof r?r.id:r,a=e(t),s=a.indexOfKey("id",o);a.splice(s,1),n(t,a,i)},t.prototype.commit=function(t,e,n,r,i){function o(){u--,0===u&&f()}var a,s=this,c=e.concat(n),u=c.length+r.length,f=i&&"function"==typeof i?i:function(){};if(0===u)return f();for(a=0;a<c.length;a++)s.save(t,c[a],o);for(a=0;a<r.length;a++)s.remove(t,r[a],o)},t}(),SQLiteProxy=function(){"use strict";function t(t){var e=null,n="undefined"!=typeof window.cordova?"deviceready":"readystatechange";document.addEventListener(n,function(){"loading"!=document.readyState&&(e=window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t,location:"default"}):window.openDatabase(t,"SQLite Database","1.0",5242880))}),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e="SELECT * FROM",n={};t.prototype=Object.create(DbProxy.prototype),t.prototype.createDatabase=function(t,e){var r=this;n=OjsUtils.cloneObject(t),r.getDb().transaction(function(t){function r(){f--,0===f&&u()}var i,o,a,s,c,u=e&&"function"==typeof e?e:function(){},f=Object.keys(n).length;for(a in n){i="";for(s in n[a])o=n[a][s],o.hasMany||(o.hasOne&&(o.type=n[o.hasOne].id.type),i+=[s,o.type,o.required?"NOT NULL":"",o.primaryKey?"PRIMARY KEY":"",","].join(" "));i=i.substr(0,i.length-1),c=["CREATE TABLE IF NOT EXISTS",a,"(",i,")"].join(" "),t.executeSql(c,[],r)}},function(t){cb(t)})};var r=function(t,e){var r,i,o,a={};for(r in n[t])i=e[r],o=n[t][r],("date"===o.type||"datetime"===o.type)&&(i=new Date(i)),a[r]=i;return a},i=function(t,e,r){var i=n[t][e],o=void 0===typeof r[e]?null:r[e];return i.hasOne&&r instanceof ChildRecord&&(o=r.getRecMaster().id),o},o=function(t,e,n,i,o){var a,s,c,u=new ArrayMap;i.executeSql(e,n,function(e,n){for(s=n.rows.length,a=0;s>a;a++)c=r(t,n.rows.item(a)),u.push(c);"function"==typeof o&&o(null,u)},function(t,e){console.error(e.message),o(e)})},a=function(t){var e,n=[];for(e in t)n.push(e+" "+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,n){var r,i=this,s=t&&t.key?t.key:t,c=t&&t.sort?a(t.sort):"",u="WHERE ",f=[];if("object"==typeof t){if(f=[e,t.key],t.params){for(r in t.params)u+=r+" = '"+t.params[r]+"'";f.push(u)}f.push(c),t.skip&&f.push("OFFSET "+t.skip),t.limit&&f.push("LIMIT "+t.limit)}else f=[e,t];i.getDb().transaction(function(t){o(s,f.join(" "),[],t,n)})};var s=function(t,e){var n,r,i="";for(n in e)if("object"==typeof e[n])for(r in e[n])switch(r){case"$gt":i+=[n,">",e[n][r]].join(" ")+" AND ";break;case"$gte":i+=[n,">=",e[n][r]].join(" ")+" AND ";break;case"$lt":i+=[n,"<",e[n][r]].join(" ")+" AND ";break;case"$lte":i+=[n,"<=",e[n][r]].join(" ")+" AND ";break;case"$start":i+=[n," LIKE '",e[n][r],"%'"].join("")+" AND ";break;case"$end":i+=[n," LIKE '%",e[n][r],"'"].join("")+" AND ";break;case"$contain":i+=[n," LIKE '%",e[n][r],"%'"].join("")+" AND ";break;case"$in":i+=[n," IN (",e[n][r].join(","),")"].join("")+" AND ";break;default:i+=""}else i+=[n," = '",e[n],"'"].join("")+" AND ";return""===i?t:(i=i.trim().slice(0,-3),[t,"WHERE",i].join(" "))},c=function(t,n,r,i){var o,a,c,u=n&&n instanceof Array?n:[n],f=r.length?r.join(",")+", ":"",p=i&&"object"==typeof i?s("",i):"",l="";return u.forEach(function(t){for(o in t)break;switch(a=t[o],c=t.alias||a,o){case"$max":l+=["MAX(",a,")"," AS ",c].join("")+", ";break;case"$min":l+=["MIN(",a,")"," AS ",c].join("")+", ";break;case"$sum":l+=["SUM(",a,")"," AS ",c].join("")+", ";break;case"$avg":l+=["AVG(",a,")"," AS ",c].join("")+", ";break;case"$count":l+=["COUNT(",a,")"," AS ",c].join("")+", "}}),""===l?[e,t].join(" "):(l=l.trim().slice(0,-1),l=["SELECT",f,l,"FROM",t,p].join(" "),""===f?l:l+" GROUP BY "+f.trim().slice(0,-1))};t.prototype.query=function(t,n,r){var i=this,a=n&&"object"==typeof n?n:{},c=[e,t].join(" "),u=n&&"function"==typeof n?n():s(c,a);i.getDb().transaction(function(e){o(t,u,[],e,r)})},t.prototype.groupBy=function(t,e,n,r,i){var o,a,s=this,u=c(t,e,n,r),f=new ArrayMap;s.getDb().transaction(function(t){t.executeSql(u,[],function(t,e){for(a=e.rows.length,o=0;a>o;o++)f.push(e.rows.item(o));"function"==typeof i&&i(null,f)},function(t,e){console.error(e.message),i(e)})})};var u=function(t,e,r,i,o){function a(){function i(){c.update(f.hasMany,h,r,o)}function o(){c["delete"](f.hasMany,d,r,s)}var a,f,p,l=new ArrayMap,h=new ArrayMap,d=new ArrayMap;for(a in e)f=n[t][a],f&&f.hasMany&&(p=e[a],p instanceof SimpleDataSet&&(u++,l.putRange(p._inserteds),h.putRange(p._updateds),d.putRange(p._deleteds),p._cleanCache(),c.insert(f.hasMany,l,r,i)));s()}function s(){u--,0===u&&o()}var c=this,u=1;i(t,e,r,a)},f=function(t,e){var r,o,a,s,c=[],u="",f="";for(r in n[t])s=n[t][r],s&&!s.hasMany&&(a=i(t,r,e),void 0!=a&&(c.push(a),u+=r+",",f+="?,"));return u=u.substr(0,u.length-1),f=f.substr(0,f.length-1),o=["INSERT INTO",t,"(",u,") VALUES (",f,")"].join(" "),{sql:o,params:c}},p=function(t,e,n,r){var i=f(t,e);n.executeSql(i.sql,i.params,r)};t.prototype.insert=function(t,e,n,r){function i(){a===o&&r()}var o=e.length,a=0;if(0===o)return r();for(;o>a;a++)u.call(this,t,e[a],n,p,i)};var l=function(t,e){var r,o,a,s,c=[],u="id = '"+e.id+"'",f="";for(o in n[t])s=n[t][o],"id"!=o&&s&&!s.hasMany&&(a=i(t,o,e),f+=o+" = ?,",c.push(a));return f=f.substr(0,f.length-1),r=["UPDATE",t,"SET",f,"WHERE",u].join(" "),{sql:r,params:c}},h=function(t,e,n,r){var i=l(t,e);n.executeSql(i.sql,i.params,r)};t.prototype.update=function(t,e,n,r){function i(){a===o&&r()}var o=e.length,a=0;if(0===o)return r();for(;o>a;a++)u.call(this,t,e[a],n,h,i)};var d=function(t,e,r,i){function o(){f--,0===f&&(a=["DELETE FROM ",t," WHERE id = '",u,"'"].join(""),r.executeSql(a,[],i))}var a,s,c,u="object"==typeof e?e.id:e,f=1;for(s in e)c=n[t][s],c&&c.hasMany&&(f++,a=["DELETE FROM ",c.hasMany," WHERE ",c.foreignKey," = '",u,"'"].join(""),r.executeSql(a,[],o),e[s]instanceof SimpleDataSet&&e[s].clear());o()};t.prototype["delete"]=function(t,e,n,r){function i(){a===o&&r()}var o=e.length,a=0;if(0===o)return r();for(;o>a;a++)d.call(this,t,e[a],n,i)},t.prototype.commit=function(t,e,n,r,i){function o(i){function o(){a.update(t,n,i,c)}function c(){a["delete"](t,r,i,s)}a.insert(t,e,i,o)}var a=this,s=i&&"function"==typeof i?i:function(){};return e.length||n.length||r.length?void a.getDb().transaction(o,function(t){console.error(t.message),s(t)}):s()};var y=function(t,e,r,i,o){var a,s,c,u={params:{}},f=n[t][i];f&&f.hasMany?(u.key=f.hasMany,u.params[f.foreignKey]=r.id,this.getRecords(u,function(t,n){if(t)return o(t);for(r[i]=new SimpleDataSet,a=0,s=n.length;s>a;a++)c=new ChildRecord(e,r),OjsUtils.cloneProperties(n[a],c),r[i].data.push(c);o()})):o()};return t.prototype.fetch=function(t,e,n,r){function i(){a--,0===a&&o()}var o="function"==typeof r?r:function(){},a=e.data.length,s=0;if(0===a)return void o();for(;a>s;s++)y.call(this,t,e,e.data[s],n,i)},t}(),RestProxy=function(){"use strict";function t(t){var e;try{e=JSON.parse(t.responseText)}catch(n){e={error:t.responseText}}this.code=t.status,this.status=t.statusText,this.error=e.error||{}}function e(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=n,DbProxy.apply(this,arguments)}var n=function(t){return JSON.stringify(t)},r=function(t){var e="function"==typeof t?t():t;return e},i=function(t,e,n,i,o){var a,s,c,u=new XMLHttpRequest;if(u.open(e,t,!0),u.onreadystatechange=function(){4===u.readyState&&(a=[200,201,304].indexOf(u.status)>-1?i:o)(u)},"object"==typeof n){c=n.data;for(s in n.headers)u.setRequestHeader(s,r(n.headers[s]))}u.send(c)},o=function(t,e,n){var r,o="object"==typeof t?t:{key:t},a=this.config.url+"/"+o.key+"?",s=new ArrayMap;if(o.params)for(r in o.params)a+=r+"="+o.params[r]+"&";if(o.sort){a+="sort=";for(r in o.sort){a+=r+" "+o.sort[r]+"&";break}}o.skip&&(a+="skip="+o.skip+"&"),o.limit&&(a+="limit="+o.limit+"&"),a=a.slice(0,-1),i(a,"GET",this.config,function(t){s.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(s)},n)},a=function(t,e,n,r,o){var a=this.config.url+"/"+e,s={};"POST"===t&&this.autoPK&&delete n.id,"PUT"===t&&(a+="/"+n.id),s.data=this.serialize(n),this.config.headers&&(s.headers=this.config.headers),i(a,t,s,r,o)};return e.prototype=Object.create(DbProxy.prototype),e.prototype.getRecords=function(e,n){o.call(this,e,function(t){n(null,t)},function(e){n(new t(e),[])})},e.prototype.query=function(e,n,r){var i={key:e,params:n};o.call(this,i,function(t){r(null,t)},function(e){r(new t(e),[])})},e.prototype.groupBy=function(t,e,n,r,i){this.query(t,e,function(t,e){if(t)return void i(t);var o=e.groupBy(n,r,{});i(null,o)})},e.prototype.insert=function(e,n,r){var i=this;a.call(i,"POST",e,n,function(t){var e=JSON.parse(t.responseText);i.autoPK&&e.id&&(n.id=e.id),r(null,t)},function(e){r(new t(e))})},e.prototype.update=function(e,n,r){a.call(this,"PUT",e,n,function(t){r(null,t)},function(e){r(new t(e))})},e.prototype["delete"]=function(e,n,r){var o=this.config.url+"/"+e+"/"+n.id,a={};this.config.headers&&(a.headers=this.config.headers),i(o,"DELETE",a,function(t){r(null,t)},function(e){r(new t(e))})},e.prototype.commit=function(t,e,n,r,i){function o(t){return u--,t&&(a=a||{messages:[]},a.messages.push(t)),0===u?void f(a):void 0}var a,s,c=this,u=e.length+n.length+r.length,f=i&&"function"==typeof i?i:function(){};if(0===u)return f();for(s=0;s<e.length;s++)c.insert(t,e[s],o);for(s=0;s<n.length;s++)c.update(t,n[s],o);for(s=0;s<r.length;s++)c["delete"](t,r[s],o)},e}(),SyncDb=function(){"use strict";function t(){}var e={Insert:"_inserted",Update:"_updated",Delete:"_deleted"},n=function(t,e){return["sync_",e,t].join("")},r=function(t,e,r){var i=n(t,e);window.localStorage[i]=JSON.stringify(r)},i=function(t,e){var r=n(t,e),i=window.localStorage[r],o=new ArrayMap;return i&&o.putRange(JSON.parse(i,DbProxy.dateParser)),o},o=function(t,e){for(var n=new ArrayMap,r=t.concat(e),i=0,o=r.length;o>i;i++)n.indexOfKey("id",r[i].id)<0&&n.put(r[i]);return n};return t.prototype.writeData=function(t,n,a,s){var c=i(e.Insert,t),u=i(e.Update,t),f=i(e.Delete,t);c=o(n,c),u=o(a,u),f=o(s,f),r(e.Insert,t,c),r(e.Update,t,u),r(e.Delete,t,f)},t.prototype.cleanData=function(t){r(e.Insert,t,[]),r(e.Update,t,[]),r(e.Delete,t,[])},t.prototype.sendData=function(t,e,n,r,i){"function"==typeof i&&i()},t.prototype.getNews=function(t,e){"function"==typeof e&&e(null,[],[])},t.prototype.exec=function(t,n){var r=this,o=n||function(){};r.sendData(t,i(e.Insert,t),i(e.Update,t),i(e.Delete,t),function(e){return e?o(e):(r.cleanData(t),void r.getNews(t,o))})},t}(),IdGenerators=function(){"use strict";return{TIMESTAMP:function(){return(new Date).getTime()},UUID:OjsUtils.uid}}(),DbFactory=function(){"use strict";function t(t,e,n){var r,i=n;if(this.getProxy=function(){return r},this.getSynchronizer=function(){return i},t&&"object"==typeof t)return void(r=t);switch(t){case 0:r=new LocalStorageProxy;break;case 1:r=new SQLiteProxy(e);break;case 2:r=new RestProxy(e);break;default:throw"Proxy not implemented"}}return t.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},t.prototype.query=function(t,e,n){this.getProxy().query(t,e,n)},t.prototype.groupBy=function(t,e,n,r,i){this.getProxy().groupBy(t,e,n,r,i)},t.prototype.createDataSet=function(t,e){var n=e||IdGenerators.TIMESTAMP;return new DataSet(this.getProxy(),t,n,this.getSynchronizer())},t}();