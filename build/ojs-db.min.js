/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var ArrayMap=function(){"use strict";function t(){var r=[];return r=Array.apply(r,arguments)||r,r.__proto__=t.prototype,r.mapTable=function(t){return this.map(function(e){return e[t]})},r.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},r.put=function(t,e){var n=e||this.length;this[n]=t},r.putRange=function(t,e){var n,r,o=e&&"boolean"==typeof e?this.length:0;if(t)for(t instanceof Array||(t=[t]),r=0,n=t.length;n>r;r++)this.put(t[r],o+r)},r.query=function(n){var r=this,o=n&&"object"==typeof n?n:{},i=new t,a=function(t){return e.call(r,t,o)},s=n&&"function"==typeof n?n:a;return i.putRange(r.filter(s)),i},r.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},r=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(e>t)},o=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(t>e)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?o(t[e],i[e]):r(t[e],i[e]);break}a=0}return a}),this},r.groupBy=function(r,o,i){var a,s,c,u=this,f=new t,p=i&&"object"==typeof i?i:{},h=o.length,l={};return u.forEach(function(t){if(e.call(u,t,p)){for(s={},c=0;h>c;c++)s[o[c]]=t[o[c]];a=JSON.stringify(s),l[a]=l[a]||[],l[a].push(t)}}),f.putRange(Object.keys(l).map(function(t){return s=JSON.parse(t),n(l[t],r,s)})),f},r.compute=function(t){return n(this,t)},r}var e=function(t,e){var n,r,o,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){o=t[n].toString();for(r in e[n]){switch(r){case"$gt":i=t[n]>e[n][r];break;case"$gte":i=t[n]>=e[n][r];break;case"$lt":i=t[n]<e[n][r];break;case"$lte":i=t[n]<=e[n][r];break;case"$not":i=t[n]!=e[n][r];break;case"$start":i=0===o.lastIndexOf(e[n][r],0);break;case"$end":i=-1!==o.indexOf(e[n][r],o.length-e[n][r].length);break;case"$contain":i=o.indexOf(e[n][r])>-1;break;case"$in":i=e[n][r].indexOf(t[n])>-1;break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},n=function(t,e,n){var r,o,i,a=e&&e instanceof Array?e:[e],s=n||{};return a.forEach(function(e){for(r in e)break;switch(o=e[r],i=e.alias||o,r){case"$max":t.sort(function(t,e){return e[o]-t[o]}),s[i]=t[0][o];break;case"$min":t.sort(function(t,e){return t[o]-e[o]}),s[i]=t[0][o];break;case"$sum":s[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":s[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),s[i]/=t.length;break;case"$count":s[i]=t.length}}),s};return t.prototype=Object.create(Array.prototype),t}(),OjsUtils=function(){"use strict";var t=function(t){for(var e,n=new Array(t),r=0;t>r;r++)0===(3&r)&&(e=4294967296*Math.random()),n[r]=e>>>((3&r)<<3)&255;return n},e=function(t){function e(t){return i[t>>18&63]+i[t>>12&63]+i[t>>6&63]+i[63&t]}var n,r,o,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,s="";for(o=0,r=t.length-a;r>o;o+=3)n=(t[o]<<16)+(t[o+1]<<8)+t[o+2],s+=e(n);switch(a){case 1:n=t[t.length-1],s+=i[n>>2],s+=i[n<<4&63],s+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],s+=i[n>>10],s+=i[n>>4&63],s+=i[n<<2&63],s+="="}return s};return{newId:function(){var t=(new Date).getTime();return performance&&performance.now&&(t=parseInt(performance.now().toString().replace(".",""))),t},uuid:function(n){return e(t(Math.ceil(Math.max(8,2*n)))).replace(/[+\/]/g,"").slice(0,n)},cloneObject:function(t){var e,n,r;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?e=new ArrayMap:t instanceof SimpleDataSet?e=new SimpleDataSet:t instanceof ChildRecord&&(e=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(e=e||[],n=0,r=t.length;r>n;n++)e[n]=this.cloneObject(t[n]);return e}if("object"==typeof t){e=e||{};for(n in t)t.hasOwnProperty(n)&&(e[n]=this.cloneObject(t[n]));return e}return t},cloneProperties:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}}}(),ChildRecord=function(){"use strict";function t(t){this.master=function(){return t}}return t}(),EventEmitter=function(){"use strict";function t(){var t={};this.topics=function(){return t}}return t.prototype.on=function(t,e){var n=this.topics();n.hasOwnProperty(t)||(n[t]=[]);var r=n[t].push(e)-1;return{remove:function(){delete n[t][r]}}},t.prototype.emit=function(t,e){var n=this.topics();n.hasOwnProperty(t)&&n[t].forEach(function(t){t(void 0!==e?e:{})})},t}(),SimplePromise=function(){"use strict";function t(t){return new i(t)}function e(t){return t&&"function"==typeof t.then}function n(n){for(var r=new i,o=[].slice.call(arguments,0),a=[],s=function(t){a.push(t),o.length===a.length&&r.resolve(a)},c=function(t){r.reject(t)},u=0,f=o.length;f>u;u++){var p=o[u];e(p)?p.then(s,c).resolve():"function"==typeof p?t().then(p).then(s,c).resolve():t().then(function(){return p}).then(s,c).resolve()}return r}var r=Object.freeze||function(){},o=function(){};o.prototype.resolve,o.prototype.reject,o.prototype.then;var i=function(t){this.state_=i.State.UNRESOLVED,this.chain_=[],this.scope_=t||null};return i.prototype.state_,i.prototype.chain_,i.prototype.scope_,i.prototype.result_,i.prototype.then=function(t,e,n){return this.chain_.push([t||null,e||null,n||null]),this.state_!==i.State.UNRESOLVED&&this.fire_(),this},i.prototype.resolve=function(t){this.state_=i.State.RESOLVED,this.fire_(t)},i.prototype.reject=function(t){this.state_=i.State.REJECTED,this.fire_(t)},i.prototype.isResolved=function(){return this.state_===i.State.RESOLVED},i.prototype.isRejected=function(){return this.state_===i.State.REJECTED},i.prototype.next=function(t,e,n){var r=n||10,o=new i(this);return o.then(t,e),this.then(function(t){setTimeout(function(){o.resolve(t)},r)},function(t){setTimeout(function(){o.reject(t)},r)}),o},i.prototype.fire_=function(t){var e="undefined"!=typeof t?t:this.result_;for(this.result_=e;this.chain_.length;){var n=this.chain_.shift(),r=this.state_===i.State.REJECTED?n[1]:n[0];if(r)try{e=this.result_=r.call(this.scope_,e)}catch(o){this.state_=i.State.REJECTED,e=this.result_=o}}},i.State={UNRESOLVED:"unresolved",RESOLVED:"resolved",REJECTED:"rejected"},r(i.State),{defer:t,isPromise:e,when:n}}(),SimpleDataSet=function(){"use strict";function t(t){EventEmitter.apply(this);var e=t||"tableName";this._history=[],this.data=new ArrayMap,this.table=function(){return e}}t.prototype=Object.create(EventEmitter.prototype),t.prototype._cleanCache=function(){this._history.length=0},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",t);return this.data[e]};var e=function(t,e){var n,r,o={op:t,record:OjsUtils.cloneObject(e)};if(r=this._history.some(function(r,o){return n=o,r.op===t&&r.record.id===e.id}))return void this._history.splice(n,1,o);if(this._history.push(o),this.emit(this.table(),{event:t,data:e}),e instanceof ChildRecord){var i=[this.table(),".child"].join("");DbEvents.emit(i,{event:t,data:e})}};return t.prototype.insert=function(t){t.id||(t.id=OjsUtils.newId());var n=this.data.indexOfKey("id",t.id);return-1===n&&(this.data.push(t),e.call(this,"insert",t)),this},t.prototype.update=function(t){if(!t.id)return this;var n=this.data.indexOfKey("id",t.id);return-1===n?this:(e.call(this,"update",this.data[n]),this.data.splice(n,1,t),this)},t.prototype.save=function(t){return t?t.id&&this.getById(t.id)?this.update(t):this.insert(t):this},t.prototype["delete"]=function(t){if(!t.id)return this;var n=this.data.indexOfKey("id",t.id);return n>=0&&(e.call(this,"delete",this.data[n]),this.data.splice(n,1)),this},t.prototype.insertAll=function(t){var e=this;return t instanceof Array?(t.forEach(function(t){e.insert(t)}),e):e},t.prototype.clear=function(t){return this.data.length=0,this._cleanCache(),t&&this.emit(this.table(),{event:"clear",data:[]}),this},t.prototype.cancel=function(){if(this._history.length){for(var t,e,n=this,r=n._history.length-1;r>=0;r--)switch(t=n._history[r],e=n.data.indexOfKey("id",t.record.id),t.op){case"insert":n.data.splice(e,1);break;case"update":n.data.splice(e,1,t.record);break;case"delete":n.data.push(t.record)}this.emit(this.table(),{event:"cancel",data:this._history}),this._history.length=0}},t.prototype.count=function(){return this.data.length},t.prototype.item=function(t){return this.data[t]},t.prototype.filter=function(t){return this.data.query(t)},t.prototype.forEach=function(t){this.data.forEach(t)},t.prototype.subscribe=function(t){return this.on(this.table(),t),this},t}(),DataSet=function(){"use strict";function t(t,n,r){SimpleDataSet.apply(this,[t]),e[t]=0,this._opts={},this._eof=!0,this._active=!1,this._reOpenOnRefresh=!1,this.proxy=function(){return n},this.synchronizer=function(){return r};var o=[t,".child"].join(""),i=this;DbEvents.on(o,function(t){i.save(t.data.master())})}var e={};t.prototype=Object.create(SimpleDataSet.prototype),t.prototype.emit=function(t,e){DbEvents.emit(t,e)},t.prototype.subscribe=function(t){return DbEvents.on(this.table(),t),this},t.prototype.sort=function(t){return this._opts.sort=t,this},t.prototype.limit=function(t){return this._opts.limit=t,this},t.prototype.where=function(t){return this._opts.params=t,this},t.prototype.reOpenOnRefresh=function(t){return this._reOpenOnRefresh="true"===t.toString(),this};var n=function(t,e){var n=this,r=e&&"function"==typeof e?e:function(){};n.proxy().getRecords(t,function(t,e){n.data.putRange(e,!0),n._active=t?!1:!0,n._eof=e&&e.length<(n._opts.limit||30),r(t,e),t||n.emit(n.table(),{event:"get",data:e})})};t.prototype.open=function(){var t={key:this.table()},e=SimplePromise.defer(),r=this;return r._active?(e.resolve(r),e):(OjsUtils.cloneProperties(r._opts,t),n.call(r,t,function(t,n){return t?void e.reject(t):void e.resolve(r)}),e)},t.prototype.next=function(){if(!this._active)throw"Invalid operation on closed dataset";(!this._opts.limit||isNaN(this._opts.limit))&&(this._opts.limit=30),e[this.table()]=++e[this.table()];var t=this,r=e[t.table()]*t._opts.limit,o={key:t.table(),skip:r},i=SimplePromise.defer();return t.eof()?(i.resolve(t),i):(OjsUtils.cloneProperties(t._opts,o),n.call(t,o,function(e,n){return e?void i.reject(e):void i.resolve(t)}),i)},t.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),e[this.table()]=0,this._active=!1,this},t.prototype.refresh=function(){if(this._reOpenOnRefresh)return this._active=!1,this.open();var t=SimplePromise.defer();return this._opts.sort&&this.data.orderBy(this._opts.sort),t.resolve(this),t},t.prototype.insert=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.insert.apply(this,arguments)},t.prototype.update=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.update.apply(this,arguments)},t.prototype["delete"]=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype["delete"].apply(this,arguments)};var r=function(t,e){var n=[];return t.forEach(function(t){t.op===e&&n.push(t.record)}),n};return t.prototype.post=function(t){function e(e){return e?(a.cancel(),void c.reject(e)):(s&&!t&&s.writeData(a.table(),n,o,i),a.refresh().then(function(){c.resolve(!0)},function(t){c.reject(t)}),void a._cleanCache())}if(!this._active)throw"Invalid operation on closed dataset";var n,o,i,a=this,s=this.synchronizer(),c=SimplePromise.defer();return a._history.length?(n=r(a._history,"insert"),o=r(a._history,"update"),i=r(a._history,"delete"),a.proxy().commit(a.table(),n,o,i,e),c):(c.resolve(!0),c)},t.prototype.sync=function(){var t=this,e=this.synchronizer(),n=SimplePromise.defer();return e?(e.exec(t.table(),function(e,r,o){function i(e){c.indexOfKey("id",e.id)<0&&t["delete"](e)}function a(e){f.indexOf(e.id)>-1&&t["delete"](e)}if(e)return void n.reject(e);if(r=r||[],o=o||[],!r.length&&!o.length)return void n.resolve(t);var s,c=new ArrayMap,u=new ArrayMap,f=o.map(function(t){return t.id});c.putRange(r),u.putRange(t.data),s=o&&o instanceof Array?a:i,u.forEach(s),c.forEach(function(e){t.save(e)}),t.post(!0).then(function(){n.resolve(t)},function(t){n.reject(t)})}),n):(n.resolve(t),n)},t.prototype.fetch=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e=SimplePromise.defer(),n=this;return this.count()?(this.proxy().fetch(this.table(),this,t,function(t){return t?void e.reject(t):void e.resolve(n)}),e):(e.resolve(n),e)},t.prototype.eof=function(){return this._eof},t.prototype.active=function(){return this._active},t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1,RESTFUL:2}}(),DbProxy=function(){function t(){}return t.prototype.createDatabase=function(t,e){},t.prototype.getRecords=function(t,e){},t.prototype.groupBy=function(t,e,n,r,o){},t.prototype.commit=function(t,e,n,r,o){},t.prototype.fetch=function(t,e,n){},t.dateParser=function(t,e){var n,r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&(n=r.exec(e))?new Date(e):e},t}(),LocalStorageProxy=function(){"use strict";function t(){DbProxy.apply(this,arguments)}var e=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],r=new ArrayMap;return n&&r.putRange(JSON.parse(n,DbProxy.dateParser)),r.length&&t.params?r.query(t.params):r},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var r=e(t);t.sort&&r.orderBy(t.sort),"function"==typeof n&&n(null,r)},t.prototype.query=function(t,n,r){var o=e(t),i=o.query(n);r(null,i)},t.prototype.groupBy=function(t,n,r,o,i){var a=e(t);i(null,a.groupBy(n,r,o))},t.prototype.save=function(t,r,o){var i=e(t),a=i.indexOfKey("id",r.id);-1===a?i.push(r):i.splice(a,1,r),n(t,i,o)},t.prototype.remove=function(t,r,o){var i="object"==typeof r?r.id:r,a=e(t),s=a.indexOfKey("id",i);a.splice(s,1),n(t,a,o)},t.prototype.commit=function(t,e,n,r,o){function i(){u--,0===u&&f()}var a,s=this,c=e.concat(n),u=c.length+r.length,f=o&&"function"==typeof o?o:function(){};if(0===u)return f();for(a=0;a<c.length;a++)s.save(t,c[a],i);for(a=0;a<r.length;a++)s.remove(t,r[a],i)},t}(),SQLiteProxy=function(){"use strict";function t(t){var e=null,n="undefined"!=typeof window.cordova?"deviceready":"readystatechange";document.addEventListener(n,function(){"loading"!=document.readyState&&(e=window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t,location:"default"}):window.openDatabase(t,"SQLite Database","1.0",5242880))}),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e="SELECT * FROM",n={};t.prototype=Object.create(DbProxy.prototype),t.prototype.createDatabase=function(t,e){var r=this;n=OjsUtils.cloneObject(t),r.getDb().transaction(function(t){function r(){f--,0===f&&u()}var o,i,a,s,c,u=e&&"function"==typeof e?e:function(){},f=Object.keys(n).length;for(a in n){o="";for(s in n[a])i=n[a][s],i.hasMany||(i.hasOne&&(i.type=n[i.hasOne].id.type),o+=[s,i.type,i.required?"NOT NULL":"",i.primaryKey?"PRIMARY KEY":"",","].join(" "));o=o.substr(0,o.length-1),c=["CREATE TABLE IF NOT EXISTS",a,"(",o,")"].join(" "),t.executeSql(c,[],r)}},function(t){cb(t)})};var r=function(t,e){var r,o,i,a={};for(r in n[t])o=e[r],i=n[t][r],("date"===i.type||"datetime"===i.type)&&(o=new Date(o)),a[r]=o;return a},o=function(t,e,r){var o=n[t][e],i=void 0===typeof r[e]?null:r[e];return o.hasOne&&r instanceof ChildRecord&&(i=r.master().id),i},i=function(t,e,n,o,i){var a,s,c,u=new ArrayMap;o.executeSql(e,n,function(e,n){for(s=n.rows.length,a=0;s>a;a++)c=r(t,n.rows.item(a)),u.push(c);"function"==typeof i&&i(null,u)},function(t,e){console.error(e.message),i(e)})},a=function(t){var e,n=[];for(e in t)n.push(e+" "+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,n){var r,o=this,s=t&&t.key?t.key:t,c=t&&t.sort?a(t.sort):"",u="WHERE ",f=[];if("object"==typeof t){if(f=[e,t.key],t.params){for(r in t.params)u+=r+" = '"+t.params[r]+"'";f.push(u)}f.push(c),t.skip&&f.push("OFFSET "+t.skip),t.limit&&f.push("LIMIT "+t.limit)}else f=[e,t];o.getDb().transaction(function(t){i(s,f.join(" "),[],t,n)})};var s=function(t,e){var n,r,o="";for(n in e)if("object"==typeof e[n])for(r in e[n])switch(r){case"$gt":o+=[n,">",e[n][r]].join(" ")+" AND ";break;case"$gte":o+=[n,">=",e[n][r]].join(" ")+" AND ";break;case"$lt":o+=[n,"<",e[n][r]].join(" ")+" AND ";break;case"$lte":o+=[n,"<=",e[n][r]].join(" ")+" AND ";break;case"$start":o+=[n," LIKE '",e[n][r],"%'"].join("")+" AND ";break;case"$end":o+=[n," LIKE '%",e[n][r],"'"].join("")+" AND ";break;case"$contain":o+=[n," LIKE '%",e[n][r],"%'"].join("")+" AND ";break;case"$in":o+=[n," IN (",e[n][r].join(","),")"].join("")+" AND ";break;default:o+=""}else o+=[n," = '",e[n],"'"].join("")+" AND ";return""===o?t:(o=o.trim().slice(0,-3),[t,"WHERE",o].join(" "))},c=function(t,n,r,o){var i,a,c,u=n&&n instanceof Array?n:[n],f=r.length?r.join(",")+", ":"",p=o&&"object"==typeof o?s("",o):"",h="";return u.forEach(function(t){for(i in t)break;switch(a=t[i],c=t.alias||a,i){case"$max":h+=["MAX(",a,")"," AS ",c].join("")+", ";break;case"$min":h+=["MIN(",a,")"," AS ",c].join("")+", ";break;case"$sum":h+=["SUM(",a,")"," AS ",c].join("")+", ";break;case"$avg":h+=["AVG(",a,")"," AS ",c].join("")+", ";break;case"$count":h+=["COUNT(",a,")"," AS ",c].join("")+", "}}),""===h?[e,t].join(" "):(h=h.trim().slice(0,-1),h=["SELECT",f,h,"FROM",t,p].join(" "),""===f?h:h+" GROUP BY "+f.trim().slice(0,-1))};t.prototype.query=function(t,n,r){var o=this,a=n&&"object"==typeof n?n:{},c=[e,t].join(" "),u=n&&"function"==typeof n?n():s(c,a);o.getDb().transaction(function(e){i(t,u,[],e,r)})},t.prototype.groupBy=function(t,e,n,r,o){var i,a,s=this,u=c(t,e,n,r),f=new ArrayMap;s.getDb().transaction(function(t){t.executeSql(u,[],function(t,e){for(a=e.rows.length,i=0;a>i;i++)f.push(e.rows.item(i));"function"==typeof o&&o(null,f)},function(t,e){console.error(e.message),o(e)})})};var u=function(t,e,r,o,i){function a(){function o(){c.update(f.hasMany,l,r,i)}function i(){c["delete"](f.hasMany,y,r,s)}var a,f,p,h=new ArrayMap,l=new ArrayMap,y=new ArrayMap;for(a in e)f=n[t][a],f&&f.hasMany&&(p=e[a],p instanceof SimpleDataSet&&(u++,h.putRange(p._inserteds),l.putRange(p._updateds),y.putRange(p._deleteds),p._cleanCache(),c.insert(f.hasMany,h,r,o)));s()}function s(){u--,0===u&&i()}var c=this,u=1;o(t,e,r,a)},f=function(t,e){var r,i,a,s,c=[],u="",f="";for(r in n[t])s=n[t][r],s&&!s.hasMany&&(a=o(t,r,e),void 0!==a&&(c.push(a),u+=r+",",f+="?,"));return u=u.substr(0,u.length-1),f=f.substr(0,f.length-1),i=["INSERT INTO",t,"(",u,") VALUES (",f,")"].join(" "),{sql:i,params:c}},p=function(t,e,n,r){var o=f(t,e);n.executeSql(o.sql,o.params,r)};t.prototype.insert=function(t,e,n,r){function o(e,o){u.call(i,t,e,n,p,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;a>s;s++)o(e[s],s)};var h=function(t,e){var r,i,a,s,c=[],u="id = '"+e.id+"'",f="";for(i in n[t])s=n[t][i],"id"!=i&&s&&!s.hasMany&&(a=o(t,i,e),f+=i+" = ?,",c.push(a));return f=f.substr(0,f.length-1),r=["UPDATE",t,"SET",f,"WHERE",u].join(" "),{sql:r,params:c}},l=function(t,e,n,r){var o=h(t,e);n.executeSql(o.sql,o.params,r)};t.prototype.update=function(t,e,n,r){function o(e,o){u.call(i,t,e,n,l,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;a>s;s++)o(e[s],s)};var y=function(t,e,r,o){function i(){f--,0===f&&(a=["DELETE FROM ",t," WHERE id = '",u,"'"].join(""),r.executeSql(a,[],o))}var a,s,c,u="object"==typeof e?e.id:e,f=1;for(s in e)c=n[t][s],c&&c.hasMany&&(f++,a=["DELETE FROM ",c.hasMany," WHERE ",c.foreignKey," = '",u,"'"].join(""),r.executeSql(a,[],i),e[s]instanceof SimpleDataSet&&e[s].clear());i()};t.prototype["delete"]=function(t,e,n,r){function o(e,o){y.call(i,t,e,n,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;a>s;s++)o(e[s],s)},t.prototype.commit=function(t,e,n,r,o){function i(o){function i(){a.update(t,n,o,c)}function c(){a["delete"](t,r,o,s)}a.insert(t,e,o,i)}var a=this,s=o&&"function"==typeof o?o:function(){};return e.length||n.length||r.length?void a.getDb().transaction(i,function(t){console.error(t.message),s(t)}):s()};var d=function(t,e,r,o){var i,a,s,c={params:{}},u=n[t][r];u&&u.hasMany?(c.key=u.hasMany,c.params[u.foreignKey]=e.id,this.getRecords(c,function(n,c){if(n)return o(n);for(e[r]=new SimpleDataSet(t),i=0,a=c.length;a>i;i++)s=new ChildRecord(e),OjsUtils.cloneProperties(c[i],s),e[r].data.push(s);o()})):o()};return t.prototype.fetch=function(t,e,n,r){function o(e,r){d.call(s,t,e,n,function(t){r===a-1&&i(t)})}var i="function"==typeof r?r:function(){},a=e.data.length,s=this,c=0;if(0===a)return i();for(;a>c;c++)o(e.data[c],c)},t}(),RestProxy=function(){"use strict";function t(t){var e;try{e=JSON.parse(t.responseText)}catch(n){e={error:t.responseText}}this.code=t.status,this.status=t.statusText,this.error=e.error||{}}function e(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=n,DbProxy.apply(this,arguments)}var n=function(t){return JSON.stringify(t)},r=function(t){var e="function"==typeof t?t():t;return e},o=function(t,e,n,o,i){var a,s,c,u=new XMLHttpRequest;if(u.open(e,t,!0),u.onreadystatechange=function(){4===u.readyState&&(a=[200,201,304].indexOf(u.status)>-1?o:i)(u)},"object"==typeof n){c=n.data;for(s in n.headers)u.setRequestHeader(s,r(n.headers[s]))}u.send(c)},i=function(t,e,n){var r,i="object"==typeof t?t:{key:t},a=this.config.url+"/"+i.key+"?",s=new ArrayMap;if(i.params)for(r in i.params)a+=r+"="+("object"==typeof i.params[r]?JSON.stringify(i.params[r]):i.params[r])+"&";if(i.sort){a+="sort=";for(r in i.sort){a+=r+(i.sort[r]?" "+i.sort[r]:"")+"&";break}}i.skip&&(a+="skip="+i.skip+"&"),i.limit&&(a+="limit="+i.limit+"&"),a=a.slice(0,-1),o(a,"GET",this.config,function(t){s.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(s)},n)},a=function(t,e,n,r,i){var a=this.config.url+"/"+e,s={};"POST"===t&&this.autoPK&&delete n.id,"PUT"===t&&(a+="/"+n.id),s.data=this.serialize(n),this.config.headers&&(s.headers=this.config.headers),o(a,t,s,r,i)};return e.prototype=Object.create(DbProxy.prototype),e.prototype.getRecords=function(e,n){i.call(this,e,function(t){n(null,t)},function(e){n(new t(e),[])})},e.prototype.query=function(e,n,r){var o={key:e,params:n};i.call(this,o,function(t){r(null,t)},function(e){r(new t(e),[])})},e.prototype.groupBy=function(t,e,n,r,o){this.query(t,e,function(t,e){if(t)return void o(t);var i=e.groupBy(n,r,{});o(null,i)})},e.prototype.insert=function(e,n,r){function o(t,o){a.call(s,"POST",e,t,function(t){var e=JSON.parse(t.responseText);s.autoPK&&e.id&&(n.id=e.id),o===c-1&&r(null,t)},i)}function i(e){r(new t(e))}var s=this,c=n.length,u=0;if(0===c)return r();for(;c>u;u++)o(n[u],u)},e.prototype.update=function(e,n,r){function o(t,n){a.call(s,"PUT",e,t,function(t){n===c-1&&r(null,t)},i)}function i(e){r(new t(e))}var s=this,c=n.length,u=0;if(0===c)return r();for(;c>u;u++)o(n[u],u)},e.prototype["delete"]=function(e,n,r){function i(t,e){var n=s+t.id;o(n,"DELETE",c,function(t){e===u-1&&r(null,t)},a)}function a(e){r(new t(e))}var s=this.config.url+"/"+e+"/",c={},u=n.length,f=0;if(0===u)return r();for(this.config.headers&&(c.headers=this.config.headers);u>f;f++)i(n[f],f)},e.prototype.commit=function(t,e,n,r,o){function i(e){return e?u(e):void s.update(t,n,a)}function a(e){return e?u(e):void s["delete"](t,r,u)}var s=this,c=e.length+n.length+r.length,u=o&&"function"==typeof o?o:function(){};return 0===c?u():void s.insert(t,e,i)},e}(),SyncDb=function(){"use strict";function t(){}var e={Insert:"inserted",Update:"updated",Delete:"deleted"},n=function(t){return["sync_",t].join("")},r=function(t){var e=n(t),r=window.localStorage[e]||"{}";return JSON.parse(r,DbProxy.dateParser)},o=function(t,e){var r=n(t);window.localStorage[r]=JSON.stringify(e)},i=function(t,e){for(var n=new ArrayMap,r=t.concat(e),o=0,i=r.length;i>o;o++)n.indexOfKey("id",r[o].id)<0&&n.put(r[o]);return n};return t.prototype.writeData=function(t,n,a,s){var c=r(t);c[e.Insert]=i(n,c[e.Insert]),c[e.Update]=i(a,c[e.Update]),c[e.Delete]=i(s,c[e.Delete]),o(t,c)},t.prototype.cleanData=function(t){o(t,{})},t.prototype.sendData=function(t,e,n,r,o){"function"==typeof o&&o()},t.prototype.getData=function(t,e){"function"==typeof e&&e(null,[],[])},t.prototype.exec=function(t,n){function o(e){return e?s(e):(i.cleanData(t),void i.getData(t,s))}var i=this,a=r(t),s=n||function(){};i.sendData(t,a[e.Insert],a[e.Update],a[e.Delete],o)},t}(),DbEvents=function(){var t=new EventEmitter;return t}(),DbFactory=function(){"use strict";function t(t,e,n){var r,o=n;if(this.proxy=function(){return r},this.synchronizer=function(){return o},t&&"object"==typeof t)return void(r=t);switch(t){case 0:r=new LocalStorageProxy;break;case 1:r=new SQLiteProxy(e);break;case 2:r=new RestProxy(e);break;default:throw"Proxy not implemented"}}t.prototype.createDatabase=function(t){var e=SimplePromise.defer();return this.proxy().createDatabase(t,function(t){return t?void e.reject(t):void e.resolve(!0)}),e},t.prototype.query=function(t,e){var n=SimplePromise.defer();return this.proxy().query(t,e,function(t,e){return t?void n.reject(t):void n.resolve(e)}),n},t.prototype.groupBy=function(t,e,n,r){var o=SimplePromise.defer();return this.proxy().groupBy(t,e,n,r,function(t,e){return t?void o.reject(t):void o.resolve(e)}),o},t.prototype.dataset=function(t){return new DataSet(t,this.proxy(),this.synchronizer())};var e=function(t,e,n,r){var o=SimplePromise.defer();return this.proxy().commit(t,e,n,r,function(t){return t?void o.reject(t):void o.resolve(!0)}),o};return t.prototype.insert=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,r,[],[])},t.prototype.update=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,[],r,[])},t.prototype["delete"]=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,[],[],r)},t}();