!function t(e,n,o){function r(a,c){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require;if(!c&&u)return u(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var f=n[a]={exports:{}};e[a][0].call(f.exports,function(t){var n=e[a][1][t];return r(n?n:t)},f,f.exports,t,e,n,o)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(t,e,n){"use strict";function o(){}function r(t){try{return t.then}catch(t){return v=t,m}}function i(t,e){try{return t(e)}catch(t){return v=t,m}}function a(t,e,n){try{t(e,n)}catch(t){return v=t,m}}function c(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==o&&y(t,this)}function u(t,e,n){return new t.constructor(function(r,i){var a=new c(o);a.then(r,i),s(t,new h(e,n,a))})}function s(t,e){for(;3===t._37;)t=t._12;return 0===t._37?void t._59.push(e):void d(function(){var n=1===t._37?e.onFulfilled:e.onRejected;if(null===n)return void(1===t._37?f(e.promise,t._12):p(e.promise,t._12));var o=i(n,t._12);o===m?p(e.promise,v):f(e.promise,o)})}function f(t,e){if(e===t)return p(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"==typeof e||"function"==typeof e)){var n=r(e);if(n===m)return p(t,v);if(n===t.then&&e instanceof c)return t._37=3,t._12=e,void l(t);if("function"==typeof n)return void y(n.bind(e),t)}t._37=1,t._12=e,l(t)}function p(t,e){t._37=2,t._12=e,l(t)}function l(t){for(var e=0;e<t._59.length;e++)s(t,t._59[e]);t._59=null}function h(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function y(t,e){var n=!1,o=a(t,function(t){n||(n=!0,f(e,t))},function(t){n||(n=!0,p(e,t))});n||o!==m||(n=!0,p(e,v))}var d=t("asap/raw"),v=null,m={};e.exports=c,c._99=o,c.prototype.then=function(t,e){if(this.constructor!==c)return u(this,t,e);var n=new c(o);return s(this,new h(t,e,n)),n}},{"asap/raw":4}],2:[function(t,e,n){"use strict";function o(t){var e=new r(r._99);return e._37=1,e._12=t,e}var r=t("./core.js");e.exports=r;var i=o(!0),a=o(!1),c=o(null),u=o(void 0),s=o(0),f=o("");r.resolve=function(t){if(t instanceof r)return t;if(null===t)return c;if(void 0===t)return u;if(t===!0)return i;if(t===!1)return a;if(0===t)return s;if(""===t)return f;if("object"==typeof t||"function"==typeof t)try{var e=t.then;if("function"==typeof e)return new r(e.bind(t))}catch(t){return new r(function(e,n){n(t)})}return o(t)},r.all=function(t){var e=Array.prototype.slice.call(t);return new r(function(t,n){function o(a,c){if(c&&("object"==typeof c||"function"==typeof c)){if(c instanceof r&&c.then===r.prototype.then){for(;3===c._37;)c=c._12;return 1===c._37?o(a,c._12):(2===c._37&&n(c._12),void c.then(function(t){o(a,t)},n))}var u=c.then;if("function"==typeof u){var s=new r(u.bind(c));return void s.then(function(t){o(a,t)},n)}}e[a]=c,0===--i&&t(e)}if(0===e.length)return t([]);for(var i=e.length,a=0;a<e.length;a++)o(a,e[a])})},r.reject=function(t){return new r(function(e,n){n(t)})},r.race=function(t){return new r(function(e,n){t.forEach(function(t){r.resolve(t).then(e,n)})})},r.prototype.catch=function(t){return this.then(null,t)}},{"./core.js":1}],3:[function(t,e,n){"use strict";function o(){if(u.length)throw u.shift()}function r(t){var e;e=c.length?c.pop():new i,e.task=t,a(e)}function i(){this.task=null}var a=t("./raw"),c=[],u=[],s=a.makeRequestCallFromTimer(o);e.exports=r,i.prototype.call=function(){try{this.task.call()}catch(t){r.onerror?r.onerror(t):(u.push(t),s())}finally{this.task=null,c[c.length]=this}}},{"./raw":4}],4:[function(t,e,n){(function(t){"use strict";function n(t){c.length||(a(),u=!0),c[c.length]=t}function o(){for(;s<c.length;){var t=s;if(s+=1,c[t].call(),s>f){for(var e=0,n=c.length-s;e<n;e++)c[e]=c[e+s];c.length-=s,s=0}}c.length=0,s=0,u=!1}function r(t){var e=1,n=new p(t),o=document.createTextNode("");return n.observe(o,{characterData:!0}),function(){e=-e,o.data=e}}function i(t){return function(){function e(){clearTimeout(n),clearInterval(o),t()}var n=setTimeout(e,0),o=setInterval(e,50)}}e.exports=n;var a,c=[],u=!1,s=0,f=1024,p=t.MutationObserver||t.WebKitMutationObserver;a="function"==typeof p?r(o):i(o),n.requestFlush=a,n.makeRequestCallFromTimer=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(t,e,n){"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){var n=arguments.length?this.then.apply(this,arguments):this;n.then(null,function(t){setTimeout(function(){throw t},0)})})},{}],6:[function(t,e,n){t("asap");"undefined"==typeof Promise&&(Promise=t("./lib/core.js"),t("./lib/es6-extensions.js")),t("./polyfill-done.js")},{"./lib/core.js":1,"./lib/es6-extensions.js":2,"./polyfill-done.js":5,asap:3}]},{},[6]);var ArrayMap=function(){"use strict";function t(){var o=[];return o=Array.apply(o,arguments)||o,o.__proto__=t.prototype,o.mapTable=function(t){return this.map(function(e){return e[t]})},o.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},o.put=function(t,e){var n=e||this.length;this[n]=t},o.putRange=function(t,e){var n,o,r=e&&"boolean"==typeof e?this.length:0;if(t)for(t instanceof Array||(t=[t]),o=0,n=t.length;o<n;o++)this.put(t[o],r+o)},o.query=function(n){var o=this,r=n&&"object"==typeof n?n:{},i=new t,a=function(t){return e.call(o,t,r)},c=n&&"function"==typeof n?n:a;return i.putRange(o.filter(c)),i},o.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},o=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(t<e)},r=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(e<t)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?r(t[e],i[e]):o(t[e],i[e]);break}a=0}return a}),this},o.groupBy=function(o,r,i){var a,c,u,s=this,f=new t,p=i&&"object"==typeof i?i:{},l=r.length,h={};return s.forEach(function(t){if(e.call(s,t,p)){for(c={},u=0;u<l;u++)c[r[u]]=t[r[u]];a=JSON.stringify(c),h[a]=h[a]||[],h[a].push(t)}}),f.putRange(Object.keys(h).map(function(t){return c=JSON.parse(t),n(h[t],o,c)})),f},o.compute=function(t){return n(this,t)},o}var e=function(t,e){var n,o,r,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){r=t[n].toString();for(o in e[n]){switch(o){case"$gt":i=t[n]>e[n][o];break;case"$gte":i=t[n]>=e[n][o];break;case"$lt":i=t[n]<e[n][o];break;case"$lte":i=t[n]<=e[n][o];break;case"$not":i=t[n]!=e[n][o];break;case"$start":i=0===r.lastIndexOf(e[n][o],0);break;case"$end":i=r.indexOf(e[n][o],r.length-e[n][o].length)!==-1;break;case"$contain":i=r.indexOf(e[n][o])>-1;break;case"$in":i=e[n][o].indexOf(t[n])>-1;break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},n=function(t,e,n){var o,r,i,a=e&&e instanceof Array?e:[e],c=n||{};return a.forEach(function(e){for(o in e)break;switch(r=e[o],i=e.alias||r,o){case"$max":t.sort(function(t,e){return e[r]-t[r]}),c[i]=t[0][r];break;case"$min":t.sort(function(t,e){return t[r]-e[r]}),c[i]=t[0][r];break;case"$sum":c[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":c[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),c[i]/=t.length;break;case"$count":c[i]=t.length}}),c};return t.prototype=Object.create(Array.prototype),t}();"object"==typeof module&&module.exports&&(module.exports.ArrayMap=ArrayMap);var OjsUtils=function(){"use strict";var t=function(t){for(var e,n=new Array(t),o=0;o<t;o++)0===(3&o)&&(e=4294967296*Math.random()),n[o]=e>>>((3&o)<<3)&255;return n},e=function(t){function e(t){return i[t>>18&63]+i[t>>12&63]+i[t>>6&63]+i[63&t]}var n,o,r,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,c="";for(r=0,o=t.length-a;r<o;r+=3)n=(t[r]<<16)+(t[r+1]<<8)+t[r+2],c+=e(n);switch(a){case 1:n=t[t.length-1],c+=i[n>>2],c+=i[n<<4&63],c+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],c+=i[n>>10],c+=i[n>>4&63],c+=i[n<<2&63],c+="="}return c};return{newId:function(){return Date.now()},uuid:function(n){return e(t(Math.ceil(Math.max(8,2*n)))).replace(/[+\/]/g,"").slice(0,n)},cloneObject:function(t){var e,n,o;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?e=new ArrayMap:t instanceof SimpleDataSet?e=new SimpleDataSet:t instanceof ChildRecord&&(e=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(e=e||[],n=0,o=t.length;n<o;n++)e[n]=this.cloneObject(t[n]);return e}if("object"==typeof t){e=e||{};for(n in t)t.hasOwnProperty(n)&&(e[n]=this.cloneObject(t[n]));return e}return t},cloneProperties:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}}}();"object"==typeof module&&module.exports&&(module.exports.OjsUtils=OjsUtils);var ChildRecord=function(){"use strict";function t(t){this.master=function(){return t}}return t}();"object"==typeof module&&module.exports&&(module.exports.ChildRecord=ChildRecord);var EventEmitter=function(){"use strict";function t(){var t={};this.topics=function(){return t}}return t.prototype.on=function(t,e){var n=this.topics();n.hasOwnProperty(t)||(n[t]=[]);var o=n[t].push(e)-1;return{remove:function(){delete n[t][o]}}},t.prototype.emit=function(t,e){var n=this.topics();n.hasOwnProperty(t)&&n[t].forEach(function(t){t(void 0!==e?e:{})})},t}();"object"==typeof module&&module.exports&&(module.exports.EventEmitter=EventEmitter);var DbEvents=function(){return new EventEmitter}();"object"==typeof module&&module.exports&&(module.exports.DbEvents=DbEvents);var SimpleDataSet=function(){"use strict";function t(t){EventEmitter.apply(this);var e=t||"tableName";this._history=[],this._data=new ArrayMap,this.table=function(){return e}}t.prototype=Object.create(EventEmitter.prototype),t.prototype._cleanCache=function(){this._history.length=0},t.prototype.get=function(t){var e=this._data.indexOfKey("id",t);return this.item(e)};var e=function(t){var e,n;return(n=this._history.some(function(n,o){return e=o,n.op===t.op&&n.record.id===t.record.id}))?void this._history.splice(e,1,t):void this._history.push(t)},n=function(t){if(this.emit(this.table(),{event:t.op,data:t.record}),t.record instanceof ChildRecord){var e=[this.table(),".child"].join("");this.emit(e,{event:t.op,data:t.record})}};return t.prototype.insert=function(t){t.id||(t.id=OjsUtils.newId());var o,r=this._data.indexOfKey("id",t.id);return r===-1&&(o={op:"insert",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.push(t),n.call(this,o)),this},t.prototype.update=function(t){if(!t.id)return this;var o,r=this._data.indexOfKey("id",t.id);return r===-1?this:(o={op:"update",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.splice(r,1,t),n.call(this,o),this)},t.prototype.save=function(t){return t?t.id&&this.get(t.id)?this.update(t):this.insert(t):this},t.prototype.delete=function(t){if(!t||!t.id)return this;var o,r=this._data.indexOfKey("id",t.id);return r>=0&&(o={op:"delete",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.splice(r,1),n.call(this,o)),this},t.prototype.insertAll=function(t){var e=this;return t instanceof Array?(t.forEach(function(t){e.insert(t)}),e):e},t.prototype.clear=function(t){return this._data.length=0,this._cleanCache(),t&&this.emit(this.table(),{event:"clear",data:[]}),this},t.prototype.cancel=function(){if(!this._history.length)return this;for(var t,e,n=this._history.length-1;n>=0;n--)switch(t=this._history[n],e=this._data.indexOfKey("id",t.record.id),t.op){case"insert":this._data.splice(e,1);break;case"update":this._data.splice(e,1,t.record);break;case"delete":this._data.push(t.record)}return this.emit(this.table(),{event:"cancel",data:this._history}),this._history.length=0,this},t.prototype.data=function(){return this._data.slice()},t.prototype.count=function(){return this._data.length},t.prototype.item=function(t){var e=this._data[t];return OjsUtils.cloneObject(e)},t.prototype.filter=function(t){return this._data.query(t)},t.prototype.forEach=function(t){this._data.forEach(t)},t.prototype.subscribe=function(t){return this._token=this.on(this.table(),t)},t.prototype.unsubscribe=function(t){return t&&"function"==typeof t.remove&&t.remove(),this},t}();"object"==typeof module&&module.exports&&(module.exports.SimpleDataSet=SimpleDataSet);var DataSet=function(){"use strict";function t(t,n,o){SimpleDataSet.apply(this,[t]),e[t]=0,this._opts={},this._eof=!0,this._active=!1;var r=[t,".child"].join(""),i=this;this.on(r,function(t){i.save(t.data.master())}),this.proxy=function(){return n},this.synchronizer=function(){return o}}var e={};t.prototype=Object.create(SimpleDataSet.prototype),t.prototype.sort=function(t){return this._opts.sort=t,this},t.prototype.limit=function(t){return this._opts.limit=t,this},t.prototype.where=function(t){return this._opts.params=t,this};var n=function(t,e){var n=this,o=e&&"function"==typeof e?e:function(){};n.proxy().getRecords(t,function(t,e){n._data.putRange(e,!0),n._active=!t,n._eof=e&&e.length<(n._opts.limit||30),o(t,e)})};t.prototype.open=function(){var t={key:this.table()},e=this;return new Promise(function(o,r){OjsUtils.cloneProperties(e._opts,t),n.call(e,t,function(t,e){return t?void r(t):void o(e)})})},t.prototype.next=function(){if(!this._active)throw"Invalid operation on closed dataset";this._opts.limit&&!isNaN(this._opts.limit)||(this._opts.limit=30),e[this.table()]=++e[this.table()];var t=this,o=e[t.table()]*t._opts.limit,r={key:t.table(),skip:o};return new Promise(function(e,o){return t.eof()?void e(t.data()):(OjsUtils.cloneProperties(t._opts,r),void n.call(t,r,function(t,n){return t?void o(t):void e(n)}))})},t.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),e[this.table()]=0,this._active=!1,this},t.prototype.clear=function(){var t=this;return new Promise(function(n,o){function r(r){return r?void o(r):(e[t.table()]=0,SimpleDataSet.prototype.clear.apply(t,arguments),void n())}t.proxy().clear(t.table(),r)})},t.prototype.refresh=function(){var t=this;return new Promise(function(e,n){t._opts.sort&&t._data.orderBy(t._opts.sort),e()})},t.prototype.insert=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.insert.apply(this,arguments)},t.prototype.update=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.update.apply(this,arguments)},t.prototype.delete=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.delete.apply(this,arguments)};var o=function(t,e){var n=[];return t.forEach(function(t){t.op===e&&n.push(t.record)}),n};return t.prototype.post=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e,n,r,i=this,a=this.synchronizer();return new Promise(function(c,u){function s(o){return o?(i.cancel(),void u(o)):(a&&!t&&a.writeData(i.table(),e,n,r),i.refresh().then(function(){c()},function(t){u(t)}),void i._cleanCache())}return i._history.length?(e=o(i._history,"insert"),n=o(i._history,"update"),r=o(i._history,"delete"),void i.proxy().commit(i.table(),e,n,r,s)):void c()})},t.prototype.sync=function(){var t=this,e=this.synchronizer();return new Promise(function(n,o){return e?void e.exec(t.table(),function(e,r,i){function a(e){s.indexOfKey("id",e.id)<0&&t.delete(e)}function c(e){p.indexOf(e.id)>-1&&t.delete(e)}if(e)return void o(e);if(r=r||[],i=i||[],!r.length&&!i.length)return void n([]);var u,s=new ArrayMap,f=new ArrayMap,p=i.map(function(t){return t.id});s.putRange(r),f.putRange(t.data()),u=i&&i instanceof Array?c:a,f.forEach(u),s.forEach(function(e){t.save(e)}),t.post(!0).then(function(){n(r)},function(t){o(t)})}):void n()})},t.prototype.fetch=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e=this;return new Promise(function(n,o){return e.count()?void e.proxy().fetch(e.table(),e,t,function(t){return t?void o(t):void n()}):void n()})},t.prototype.eof=function(){return this._eof},t.prototype.active=function(){return this._active},t}();"object"==typeof module&&module.exports&&(module.exports.DataSet=DataSet);var DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1,RESTFUL:2}}();"object"==typeof module&&module.exports&&(module.exports.DbProxies=DbProxies);var DbProxy=function(){"use strict";function t(){}return t.prototype.createDatabase=function(t,e){"function"==typeof e&&e()},t.prototype.getRecords=function(t,e){"function"==typeof e&&e(null,[])},t.prototype.groupBy=function(t,e,n,o,r){"function"==typeof r&&r(null,[])},t.prototype.commit=function(t,e,n,o,r){"function"==typeof r&&r()},t.prototype.fetch=function(t,e,n){"function"==typeof n&&n()},t.prototype.clear=function(t,e){"function"==typeof e&&e()},t.dateParser=function(t,e){var n,o=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&(n=o.exec(e))?new Date(e):e},t}();"object"==typeof module&&module.exports&&(module.exports.DbProxy=DbProxy);var LocalStorageProxy=function(){"use strict";function t(){DbProxy.apply(this,arguments)}var e=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],o=new ArrayMap;return n&&o.putRange(JSON.parse(n,DbProxy.dateParser)),o.length&&t.params?o.query(t.params):o},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var o=e(t);t.sort&&o.orderBy(t.sort),"function"==typeof n&&n(null,o)},t.prototype.query=function(t,n,o){var r=e(t),i=r.query(n);o(null,i)},t.prototype.groupBy=function(t,n,o,r,i){var a=e(t),c=a.groupBy(n,o,r);i(null,c)};var o=function(t,e){var n=t.indexOfKey("id",e.id);n===-1?t.push(e):t.splice(n,1,e)},r=function(t,e){var n="object"==typeof e?e.id:e,o=t.indexOfKey("id",n);t.splice(o,1)};return t.prototype.commit=function(t,i,a,c,u){var s,f=i.concat(a),p=f.length+c.length,l=e(t),h=u&&"function"==typeof u?u:function(){};if(0===p)return h();for(s=0;s<f.length;s++)o.call(this,l,f[s]);for(s=0;s<c.length;s++)r.call(this,l,c[s]);n(t,l,h)},t.prototype.clear=function(t,e){n(t,[],e)},t}();"object"==typeof module&&module.exports&&(module.exports.LocalStorageProxy=LocalStorageProxy);var SQLiteProxy=function(){"use strict";function t(t){function e(){n=window.sqlitePlugin?window.sqlitePlugin.openDatabase(o):window.openDatabase(o.name,"SQLite Database","1.0",5242880)}var n=null,o={},r="undefined"!=typeof window.cordova;"object"==typeof t?(o.name=t.name,o.location=t.location||"default"):o.name=t,r?document.addEventListener("deviceready",e):e(),this.getDb=function(){return n},DbProxy.apply(this,arguments)}var e="SELECT * FROM",n={};t.prototype=Object.create(DbProxy.prototype),t.prototype.createDatabase=function(t,e){var o=this;n=OjsUtils.cloneObject(t),o.getDb().transaction(function(t){function o(){f--,0===f&&s()}var r,i,a,c,u,s=e&&"function"==typeof e?e:function(){},f=Object.keys(n).length;for(a in n){r="";for(c in n[a])i=n[a][c],i.hasMany||(i.hasOne&&(i.type=n[i.hasOne].id.type),r+=[c,i.type,i.required?"NOT NULL":"",i.primaryKey?"PRIMARY KEY":"",","].join(" "));r=r.substr(0,r.length-1),u=["CREATE TABLE IF NOT EXISTS",a,"(",r,")"].join(" "),t.executeSql(u,[],o)}},function(t){cb(t)})};var o=function(t,e){var o,r,i,a={};for(o in n[t])r=e[o],i=n[t][o],"date"!==i.type&&"datetime"!==i.type||(r=new Date(r)),a[o]=r;return a},r=function(t,e,o){var r=n[t][e],i=void 0===typeof o[e]?null:o[e];return r.hasOne&&o instanceof ChildRecord&&(i=o.master().id),i},i=function(t,e,n,r,i){var a,c,u,s=new ArrayMap;r.executeSql(e,n,function(e,n){for(c=n.rows.length,a=0;a<c;a++)u=o(t,n.rows.item(a)),s.push(u);"function"==typeof i&&i(null,s)},function(t,e){console.error(e.message),i(e)})},a=function(t){var e,n=[];for(e in t)n.push(e+" "+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,n){var o,r=this,c=t&&t.key?t.key:t,u=t&&t.sort?a(t.sort):"",s="WHERE ",f=[];if("object"==typeof t){if(f=[e,t.key],t.params){for(o in t.params)s+=o+" = '"+t.params[o]+"'";f.push(s)}f.push(u),t.skip&&f.push("OFFSET "+t.skip),t.limit&&f.push("LIMIT "+t.limit)}else f=[e,t];r.getDb().transaction(function(t){i(c,f.join(" "),[],t,n)})};var c=function(t,e){var n,o,r="";for(n in e)if("object"==typeof e[n])for(o in e[n])switch(o){case"$gt":r+=[n,">",e[n][o]].join(" ")+" AND ";break;case"$gte":r+=[n,">=",e[n][o]].join(" ")+" AND ";break;case"$lt":r+=[n,"<",e[n][o]].join(" ")+" AND ";break;case"$lte":r+=[n,"<=",e[n][o]].join(" ")+" AND ";break;case"$start":r+=[n," LIKE '",e[n][o],"%'"].join("")+" AND ";break;case"$end":r+=[n," LIKE '%",e[n][o],"'"].join("")+" AND ";break;case"$contain":r+=[n," LIKE '%",e[n][o],"%'"].join("")+" AND ";break;case"$in":r+=[n," IN (",e[n][o].join(","),")"].join("")+" AND ";break;default:r+=""}else r+=[n," = '",e[n],"'"].join("")+" AND ";return""===r?t:(r=r.trim().slice(0,-3),[t,"WHERE",r].join(" "))},u=function(t,n,o,r){var i,a,u,s=n&&n instanceof Array?n:[n],f=o.length?o.join(",")+", ":"",p=r&&"object"==typeof r?c("",r):"",l="";return s.forEach(function(t){for(i in t)break;switch(a=t[i],u=t.alias||a,i){case"$max":l+=["MAX(",a,")"," AS ",u].join("")+", ";break;case"$min":l+=["MIN(",a,")"," AS ",u].join("")+", ";break;case"$sum":l+=["SUM(",a,")"," AS ",u].join("")+", ";break;case"$avg":l+=["AVG(",a,")"," AS ",u].join("")+", ";break;case"$count":l+=["COUNT(",a,")"," AS ",u].join("")+", "}}),""===l?[e,t].join(" "):(l=l.trim().slice(0,-1),l=["SELECT",f,l,"FROM",t,p].join(" "),""===f?l:l+" GROUP BY "+f.trim().slice(0,-1))};t.prototype.query=function(t,n,o){var r=this,a=n&&"object"==typeof n?n:{},u=[e,t].join(" "),s=n&&"function"==typeof n?n():c(u,a);r.getDb().transaction(function(e){i(t,s,[],e,o)})},t.prototype.groupBy=function(t,e,n,o,r){var i,a,c=this,s=u(t,e,n,o),f=new ArrayMap;c.getDb().transaction(function(t){t.executeSql(s,[],function(t,e){for(a=e.rows.length,i=0;i<a;i++)f.push(e.rows.item(i));"function"==typeof r&&r(null,f)},function(t,e){console.error(e.message),r(e)})})};var s=function(t,e,o,r,i){function a(){function r(){u.update(f.hasMany,h,o,i)}function i(){u.delete(f.hasMany,y,o,c)}var a,f,p,l=new ArrayMap,h=new ArrayMap,y=new ArrayMap;for(a in e)f=n[t][a],f&&f.hasMany&&(p=e[a],p instanceof SimpleDataSet&&(s++,l.putRange(p._inserteds),h.putRange(p._updateds),y.putRange(p._deleteds),p._cleanCache(),u.insert(f.hasMany,l,o,r)));c()}function c(){s--,0===s&&i()}var u=this,s=1;r(t,e,o,a)},f=function(t,e){var o,i,a,c,u=[],s="",f="";for(o in n[t])c=n[t][o],c&&!c.hasMany&&(a=r(t,o,e),void 0!==a&&(u.push(a),s+=o+",",f+="?,"));return s=s.substr(0,s.length-1),f=f.substr(0,f.length-1),i=["INSERT INTO",t,"(",s,") VALUES (",f,")"].join(" "),{sql:i,params:u}},p=function(t,e,n,o){var r=f(t,e);n.executeSql(r.sql,r.params,o)};t.prototype.insert=function(t,e,n,o){function r(e,r){s.call(i,t,e,n,p,function(){r===a-1&&o()})}var i=this,a=e.length,c=0;if(0===a)return o();for(;c<a;c++)r(e[c],c)};var l=function(t,e){var o,i,a,c,u=[],s="id = '"+e.id+"'",f="";for(i in n[t])c=n[t][i],"id"!=i&&c&&!c.hasMany&&(a=r(t,i,e),f+=i+" = ?,",u.push(a));return f=f.substr(0,f.length-1),o=["UPDATE",t,"SET",f,"WHERE",s].join(" "),{sql:o,params:u}},h=function(t,e,n,o){var r=l(t,e);n.executeSql(r.sql,r.params,o)};t.prototype.update=function(t,e,n,o){function r(e,r){s.call(i,t,e,n,h,function(){r===a-1&&o()})}var i=this,a=e.length,c=0;if(0===a)return o();for(;c<a;c++)r(e[c],c)};var y=function(t,e,o,r){function i(){f--,0===f&&(a=["DELETE FROM ",t," WHERE id = '",s,"'"].join(""),o.executeSql(a,[],function(){r()}))}var a,c,u,s="object"==typeof e?e.id:e,f=1;for(c in e)u=n[t][c],u&&u.hasMany&&(f++,a=["DELETE FROM ",u.hasMany," WHERE ",u.foreignKey," = '",s,"'"].join(""),o.executeSql(a,[],i),e[c]instanceof SimpleDataSet&&e[c].clear());i()};t.prototype.delete=function(t,e,n,o){function r(e,r){y.call(i,t,e,n,function(){r===a-1&&o()})}var i=this,a=e.length,c=0;if(0===a)return o();for(;c<a;c++)r(e[c],c)},t.prototype.commit=function(t,e,n,o,r){function i(r){function i(){a.update(t,n,r,u)}function u(){a.delete(t,o,r,c)}a.insert(t,e,r,i)}var a=this,c=r&&"function"==typeof r?r:function(){};return e.length||n.length||o.length?void a.getDb().transaction(i,function(t){console.error(t.message),c(t)}):c()};var d=function(t,e,o,r){var i,a,c,u={params:{}},s=n[t][o];return e[o]instanceof SimpleDataSet||!s||!s.hasMany?r():(u.key=s.hasMany,u.params[s.foreignKey]=e.id,void this.getRecords(u,function(n,u){if(n)return r(n);for(e[o]=new SimpleDataSet(t),i=0,a=u.length;i<a;i++)c=new ChildRecord(e),OjsUtils.cloneProperties(u[i],c),e[o].data.push(c);r()}))};return t.prototype.fetch=function(t,e,n,o){function r(e,o){d.call(c,t,e,n,function(t){o===a-1&&i(t)})}var i="function"==typeof o?o:function(){},a=e.data.length,c=this,u=0;if(0===a)return i();for(;u<a;u++)r(e.data[u],u)},t.prototype.clear=function(t,e){function o(e){function o(){c--,0===c&&e.executeSql("DELETE FROM "+t,[],function(){a()})}for(i in n[t])n[t][i].hasMany&&(c++,r=["DELETE FROM ",n[t][i].hasMany].join(""),e.executeSql(r,[],o));o()}var r,i,a="function"==typeof e?e:function(){},c=1;this.getDb().transaction(o,a)},t}();"object"==typeof module&&module.exports&&(module.exports.SQLiteProxy=SQLiteProxy);var RestProxy=function(){"use strict";function t(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=e,DbProxy.apply(this,arguments)}var e=function(t){return JSON.stringify(t)},n=function(t){var e="function"==typeof t?t():t;return e},o=function(t,e,o,r,i){var a,c,u,s=new XMLHttpRequest;if(s.open(e,t,!0),s.onreadystatechange=function(){4===s.readyState&&(a=[200,201,204,304].indexOf(s.status)>-1?r:i)(s)},"object"==typeof o){u=o.data;for(c in o.headers)s.setRequestHeader(c,n(o.headers[c]))}s.send(u)},r=function(t,e,n){var r,i="object"==typeof t?t:{key:t},a=this.config.url+"/"+i.key+"?",c=new ArrayMap;if(i.params)for(r in i.params)a+=r+"="+("object"==typeof i.params[r]?JSON.stringify(i.params[r]):i.params[r])+"&";if(i.sort){a+="sort=";for(r in i.sort){a+=r+(i.sort[r]?" "+i.sort[r]:"")+"&";break}}i.skip&&(a+="skip="+i.skip+"&"),i.limit&&(a+="limit="+i.limit+"&"),a=a.slice(0,-1),o(a,"GET",this.config,function(t){c.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(c)},n)},i=function(t,e,n,r,i){var a=this.config.url+"/"+e,c={};"POST"===t&&this.autoPK&&delete n.id,"PUT"===t&&(a+="/"+n.id),c.data=this.serialize(n),this.config.headers&&(c.headers=this.config.headers),o(a,t,c,r,i)},a=function(t){var e;try{e=JSON.parse(t.responseText)}catch(n){e={message:t.responseText}}return e};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,e){r.call(this,t,function(t){e(null,t)},function(t){e(a(t),[])})},t.prototype.query=function(t,e,n){var o={key:t,params:e};r.call(this,o,function(t){n(null,t)},function(t){n(a(t),[])})},t.prototype.groupBy=function(t,e,n,o,r){this.query(t,e,function(t,e){if(t)return void r(t);var i=e.groupBy(n,o,{});r(null,i)})},t.prototype.insert=function(t,e,n){function o(o,u){i.call(r,"POST",t,o,function(t){var o=JSON.parse(t.responseText);r.autoPK&&o.id&&(e.id=o.id),u===c-1&&n(null,t)},function(t){n(a(t))})}var r=this,c=e.length,u=0;if(0===c)return n();for(;u<c;u++)o(e[u],u)},t.prototype.update=function(t,e,n){function o(e,o){i.call(r,"PUT",t,e,function(t){o===c-1&&n(null,t)},function(t){n(a(t))})}var r=this,c=e.length,u=0;if(0===c)return n();for(;u<c;u++)o(e[u],u)},t.prototype.delete=function(t,e,n){function r(t,e){var r=i+t.id;o(r,"DELETE",c,function(t){e===u-1&&n(null,t)},function(t){n(a(t))})}var i=this.config.url+"/"+t+"/",c={},u=e.length,s=0;if(0===u)return n();for(this.config.headers&&(c.headers=this.config.headers);s<u;s++)r(e[s],s)},t.prototype.commit=function(t,e,n,o,r){function i(e){return e?s(e):void c.update(t,n,a)}function a(e){return e?s(e):void c.delete(t,o,s)}var c=this,u=e.length+n.length+o.length,s=r&&"function"==typeof r?r:function(){};return 0===u?s():void c.insert(t,e,i)},t}();"object"==typeof module&&module.exports&&(module.exports.RestProxy=RestProxy);var DbSync=function(){"use strict";function t(){}var e={Insert:"inserted",Update:"updated",Delete:"deleted"},n=function(t){return["sync_",t].join("")},o=function(t){var e=n(t),o=window.localStorage[e]||"{}";return JSON.parse(o,DbProxy.dateParser)},r=function(t,e){var o=n(t);window.localStorage[o]=JSON.stringify(e)},i=function(t,e){for(var n=new ArrayMap,o=t.concat(e||[]),r=0,i=o.length;r<i;r++)n.indexOfKey("id",o[r].id)<0&&n.put(o[r]);return n};return t.prototype.writeData=function(t,n,a,c){var u=o(t);n.length&&(u[e.Insert]=i(n,u[e.Insert])),a.length&&(u[e.Update]=i(a,u[e.Update])),c.length&&(u[e.Delete]=i(c,u[e.Delete])),r(t,u)},t.prototype.cleanData=function(t){r(t,{})},t.prototype.sendData=function(t,e,n,o,r){"function"==typeof r&&r()},t.prototype.getData=function(t,e){"function"==typeof e&&e(null,[],[])},t.prototype.exec=function(t,n){function r(e){return e?c(e):(i.cleanData(t),void i.getData(t,c))}var i=this,a=o(t),c=n||function(){};i.sendData(t,a[e.Insert]||[],a[e.Update]||[],a[e.Delete]||[],r)},t}();"object"==typeof module&&module.exports&&(module.exports.DbSync=DbSync);/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var DbFactory=function(){"use strict";function t(t,e,n){var o,r=n;if(this.proxy=function(){return o},this.synchronizer=function(){return r},t&&"object"==typeof t)return void(o=t);switch(t){case 0:o=new LocalStorageProxy;break;case 1:o=new SQLiteProxy(e);break;case 2:o=new RestProxy(e);break;default:throw"Proxy not implemented"}}t.prototype.createDb=function(t){var e=this;return new Promise(function(n,o){e.proxy().createDatabase(t,function(t){return t?void o(t):void n()})})},t.prototype.query=function(t,e){var n=this;return new Promise(function(o,r){n.proxy().query(t,e,function(t,e){return t?void r(t):void o(e)})})},t.prototype.groupBy=function(t,e,n,o){var r=this;return new Promise(function(i,a){r.proxy().groupBy(t,e,n,o,function(t,e){return t?void a(t):void i(e)})})},t.prototype.dataset=function(t){return new DataSet(t,this.proxy(),this.synchronizer())};var e=function(t,e,n,o){var r=this;return new Promise(function(i,a){r.proxy().commit(t,e,n,o,function(t){return t?void a(t):void i()})})};return t.prototype.insert=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,o,[],[])},t.prototype.update=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,[],o,[])},t.prototype.delete=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,[],[],o)},t}(),ojsDb=DbFactory;"object"==typeof module&&module.exports&&(module.exports.DbFactory=DbFactory);