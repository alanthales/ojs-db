!function t(e,n,o){function r(a,c){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require;if(!c&&u)return u(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var f=n[a]={exports:{}};e[a][0].call(f.exports,function(t){var n=e[a][1][t];return r(n||t)},f,f.exports,t,e,n,o)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(t,e,n){"use strict";function o(){}function r(t){try{return t.then}catch(t){return v=t,m}}function i(t,e){try{return t(e)}catch(t){return v=t,m}}function a(t,e,n){try{t(e,n)}catch(t){return v=t,m}}function c(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==o&&h(t,this)}function u(t,e,n){return new t.constructor(function(r,i){var a=new c(o);a.then(r,i),s(t,new d(e,n,a))})}function s(t,e){for(;3===t._37;)t=t._12;if(0===t._37)return void t._59.push(e);y(function(){var n=1===t._37?e.onFulfilled:e.onRejected;if(null===n)return void(1===t._37?f(e.promise,t._12):p(e.promise,t._12));var o=i(n,t._12);o===m?p(e.promise,v):f(e.promise,o)})}function f(t,e){if(e===t)return p(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"==typeof e||"function"==typeof e)){var n=r(e);if(n===m)return p(t,v);if(n===t.then&&e instanceof c)return t._37=3,t._12=e,void l(t);if("function"==typeof n)return void h(n.bind(e),t)}t._37=1,t._12=e,l(t)}function p(t,e){t._37=2,t._12=e,l(t)}function l(t){for(var e=0;e<t._59.length;e++)s(t,t._59[e]);t._59=null}function d(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function h(t,e){var n=!1,o=a(t,function(t){n||(n=!0,f(e,t))},function(t){n||(n=!0,p(e,t))});n||o!==m||(n=!0,p(e,v))}var y=t("asap/raw"),v=null,m={};e.exports=c,c._99=o,c.prototype.then=function(t,e){if(this.constructor!==c)return u(this,t,e);var n=new c(o);return s(this,new d(t,e,n)),n}},{"asap/raw":4}],2:[function(t,e,n){"use strict";function o(t){var e=new r(r._99);return e._37=1,e._12=t,e}var r=t("./core.js");e.exports=r;var i=o(!0),a=o(!1),c=o(null),u=o(void 0),s=o(0),f=o("");r.resolve=function(t){if(t instanceof r)return t;if(null===t)return c;if(void 0===t)return u;if(!0===t)return i;if(!1===t)return a;if(0===t)return s;if(""===t)return f;if("object"==typeof t||"function"==typeof t)try{var e=t.then;if("function"==typeof e)return new r(e.bind(t))}catch(t){return new r(function(e,n){n(t)})}return o(t)},r.all=function(t){var e=Array.prototype.slice.call(t);return new r(function(t,n){function o(a,c){if(c&&("object"==typeof c||"function"==typeof c)){if(c instanceof r&&c.then===r.prototype.then){for(;3===c._37;)c=c._12;return 1===c._37?o(a,c._12):(2===c._37&&n(c._12),void c.then(function(t){o(a,t)},n))}var u=c.then;if("function"==typeof u){return void new r(u.bind(c)).then(function(t){o(a,t)},n)}}e[a]=c,0==--i&&t(e)}if(0===e.length)return t([]);for(var i=e.length,a=0;a<e.length;a++)o(a,e[a])})},r.reject=function(t){return new r(function(e,n){n(t)})},r.race=function(t){return new r(function(e,n){t.forEach(function(t){r.resolve(t).then(e,n)})})},r.prototype.catch=function(t){return this.then(null,t)}},{"./core.js":1}],3:[function(t,e,n){"use strict";function o(){if(u.length)throw u.shift()}function r(t){var e;e=c.length?c.pop():new i,e.task=t,a(e)}function i(){this.task=null}var a=t("./raw"),c=[],u=[],s=a.makeRequestCallFromTimer(o);e.exports=r,i.prototype.call=function(){try{this.task.call()}catch(t){r.onerror?r.onerror(t):(u.push(t),s())}finally{this.task=null,c[c.length]=this}}},{"./raw":4}],4:[function(t,e,n){(function(t){"use strict";function n(t){a.length||(i(),c=!0),a[a.length]=t}function o(){for(;u<a.length;){var t=u;if(u+=1,a[t].call(),u>s){for(var e=0,n=a.length-u;e<n;e++)a[e]=a[e+u];a.length-=u,u=0}}a.length=0,u=0,c=!1}function r(t){return function(){function e(){clearTimeout(n),clearInterval(o),t()}var n=setTimeout(e,0),o=setInterval(e,50)}}e.exports=n;var i,a=[],c=!1,u=0,s=1024,f=t.MutationObserver||t.WebKitMutationObserver;i="function"==typeof f?function(t){var e=1,n=new f(t),o=document.createTextNode("");return n.observe(o,{characterData:!0}),function(){e=-e,o.data=e}}(o):r(o),n.requestFlush=i,n.makeRequestCallFromTimer=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(t,e,n){"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})})},{}],6:[function(t,e,n){t("asap");"undefined"==typeof Promise&&(Promise=t("./lib/core.js"),t("./lib/es6-extensions.js")),t("./polyfill-done.js")},{"./lib/core.js":1,"./lib/es6-extensions.js":2,"./polyfill-done.js":5,asap:3}]},{},[6]);var ArrayMap=function(){"use strict";function t(){var o=[];return o=Array.apply(o,arguments)||o,o.__proto__=t.prototype,o.mapTable=function(t){return this.map(function(e){return e[t]})},o.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},o.put=function(t,e){this[e||this.length]=t},o.putRange=function(t,e){var n,o,r=e&&"boolean"==typeof e?this.length:0;if(t)for(t instanceof Array||(t=[t]),o=0,n=t.length;o<n;o++)this.put(t[o],r+o)},o.query=function(n){var o=this,r=n&&"object"==typeof n?n:{},i=new t,a=function(t){return e.call(o,t,r)},c=n&&"function"==typeof n?n:a;return i.putRange(o.filter(c)),i},o.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},o=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(t<e)},r=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(e<t)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?r(t[e],i[e]):o(t[e],i[e]);break}a=0}return a}),this},o.groupBy=function(o,r,i){var a,c,u,s=this,f=new t,p=i&&"object"==typeof i?i:{},l=r.length,d={};return s.forEach(function(t){if(e.call(s,t,p)){for(c={},u=0;u<l;u++)c[r[u]]=t[r[u]];a=JSON.stringify(c),d[a]=d[a]||[],d[a].push(t)}}),f.putRange(Object.keys(d).map(function(t){return c=JSON.parse(t),n(d[t],o,c)})),f},o.compute=function(t){return n(this,t)},o}var e=function(t,e){var n,o,r,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){r=t[n].toString();for(o in e[n]){switch(o){case"$gt":i=t[n]>e[n][o];break;case"$gte":i=t[n]>=e[n][o];break;case"$lt":i=t[n]<e[n][o];break;case"$lte":i=t[n]<=e[n][o];break;case"$not":i=t[n]!=e[n][o];break;case"$start":i=0===r.lastIndexOf(e[n][o],0);break;case"$end":i=-1!==r.indexOf(e[n][o],r.length-e[n][o].length);break;case"$contain":i=r.indexOf(e[n][o])>-1;break;case"$in":i=e[n][o].indexOf(t[n])>-1;break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},n=function(t,e,n){var o,r,i,a=e&&e instanceof Array?e:[e],c=n||{};return a.forEach(function(e){for(o in e)break;switch(r=e[o],i=e.alias||r,o){case"$max":t.sort(function(t,e){return e[r]-t[r]}),c[i]=t[0][r];break;case"$min":t.sort(function(t,e){return t[r]-e[r]}),c[i]=t[0][r];break;case"$sum":c[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":c[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),c[i]/=t.length;break;case"$count":c[i]=t.length}}),c};return t.prototype=Object.create(Array.prototype),t}();"object"==typeof module&&module.exports&&(module.exports.ArrayMap=ArrayMap);var OjsUtils=function(){"use strict";var t=function(t){for(var e,n=new Array(t),o=0;o<t;o++)0==(3&o)&&(e=4294967296*Math.random()),n[o]=e>>>((3&o)<<3)&255;return n},e=function(t){var e,n,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=t.length%3,a="";for(o=0,n=t.length-i;o<n;o+=3)e=(t[o]<<16)+(t[o+1]<<8)+t[o+2],a+=function(t){return r[t>>18&63]+r[t>>12&63]+r[t>>6&63]+r[63&t]}(e);switch(i){case 1:e=t[t.length-1],a+=r[e>>2],a+=r[e<<4&63],a+="==";break;case 2:e=(t[t.length-2]<<8)+t[t.length-1],a+=r[e>>10],a+=r[e>>4&63],a+=r[e<<2&63],a+="="}return a};return{newId:function(){return Date.now()},uuid:function(n){return e(t(Math.ceil(Math.max(8,2*n)))).replace(/[+\/]/g,"").slice(0,n)},cloneObject:function(t){var e,n,o;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?e=new ArrayMap:t instanceof SimpleDataSet?e=new SimpleDataSet:t instanceof ChildRecord&&(e=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(e=e||[],n=0,o=t.length;n<o;n++)e[n]=this.cloneObject(t[n]);return e}if("object"==typeof t){e=e||{};for(n in t)t.hasOwnProperty(n)&&(e[n]=this.cloneObject(t[n]));return e}return t},cloneProperties:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}}}();"object"==typeof module&&module.exports&&(module.exports.OjsUtils=OjsUtils);var ChildRecord=function(){"use strict";function t(t){this.master=function(){return t}}return t}();"object"==typeof module&&module.exports&&(module.exports.ChildRecord=ChildRecord);var EventEmitter=function(){"use strict";function t(){var t={};this.topics=function(){return t}}return t.prototype.on=function(t,e){var n=this.topics();n.hasOwnProperty(t)||(n[t]=[]);var o=n[t].push(e)-1;return{remove:function(){delete n[t][o]}}},t.prototype.emit=function(t,e){var n=this.topics();n.hasOwnProperty(t)&&n[t].forEach(function(t){t(void 0!==e?e:{})})},t}();"object"==typeof module&&module.exports&&(module.exports.EventEmitter=EventEmitter);var DbEvents=function(){return new EventEmitter}();"object"==typeof module&&module.exports&&(module.exports.DbEvents=DbEvents);var SimpleDataSet=function(){"use strict";function t(t){EventEmitter.apply(this);var e=t||"tableName";this._history=[],this._data=new ArrayMap,this.table=function(){return e}}t.prototype=Object.create(EventEmitter.prototype),t.prototype._cleanCache=function(){this._history.length=0},t.prototype.get=function(t){var e=this._data.indexOfKey("id",t);return this.item(e)};var e=function(t){var e;if(this._history.some(function(n,o){return e=o,n.op===t.op&&n.record.id===t.record.id}))return void this._history.splice(e,1,t);this._history.push(t)},n=function(t){if(this.emit(this.table(),{event:t.op,data:t.record}),t.record instanceof ChildRecord){var e=[this.table(),".child"].join("");DbEvents.emit(e,{event:t.op,data:t.record})}};return t.prototype.insert=function(t){t.id||(t.id=OjsUtils.newId());var o,r=this._data.indexOfKey("id",t.id);return-1===r&&(o={op:"insert",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.push(t),n.call(this,o)),this},t.prototype.update=function(t){if(!t.id)return this;var o,r=this._data.indexOfKey("id",t.id);return-1===r?this:(o={op:"update",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.splice(r,1,t),n.call(this,o),this)},t.prototype.save=function(t){return t?t.id&&this.get(t.id)?this.update(t):this.insert(t):this},t.prototype.delete=function(t){if(!t||!t.id)return this;var o,r=this._data.indexOfKey("id",t.id);return r>=0&&(o={op:"delete",record:OjsUtils.cloneObject(t)},e.call(this,o),this._data.splice(r,1),n.call(this,o)),this},t.prototype.insertAll=function(t){var e=this;return t instanceof Array?(t.forEach(function(t){e.insert(t)}),e):e},t.prototype.clear=function(t){return this._data.length=0,this._cleanCache(),t&&this.emit(this.table(),{event:"clear",data:[]}),this},t.prototype.cancel=function(){if(!this._history.length)return this;for(var t,e,n=this._history.length-1;n>=0;n--)switch(t=this._history[n],e=this._data.indexOfKey("id",t.record.id),t.op){case"insert":this._data.splice(e,1);break;case"update":this._data.splice(e,1,t.record);break;case"delete":this._data.push(t.record)}return this.emit(this.table(),{event:"cancel",data:this._history}),this._history.length=0,this},t.prototype.data=function(){return this._data.slice()},t.prototype.count=function(){return this._data.length},t.prototype.item=function(t){var e=this._data[t];return OjsUtils.cloneObject(e)},t.prototype.filter=function(t){return this._data.query(t)},t.prototype.forEach=function(t){this._data.forEach(t)},t.prototype.subscribe=function(t){return this.on(this.table(),t)},t.prototype.unsubscribe=function(t){return t&&"function"==typeof t.remove&&t.remove(),this},t}();"object"==typeof module&&module.exports&&(module.exports.SimpleDataSet=SimpleDataSet);var DataSet=function(){"use strict";function t(t,n,o){SimpleDataSet.apply(this,[t]),e[t]=0,this._opts={},this._eof=!0,this._active=!1;var r=[t,".child"].join(""),i=this;DbEvents.on(t,function(t){if("key"===t.event){var e=i._data.indexOfKey("id",t.data.oldId);i._data[e].id=t.data.newId}}),DbEvents.on(r,function(t){i.save(t.data.master())}),this.proxy=function(){return n},this.synchronizer=function(){return o}}var e={};t.prototype=Object.create(SimpleDataSet.prototype),t.prototype.sort=function(t){return this._opts.sort=t,this},t.prototype.limit=function(t){return this._opts.limit=t,this},t.prototype.where=function(t){return this._opts.params=t,this};var n=function(t,e){var n=this,o=e&&"function"==typeof e?e:function(){};n.proxy().getRecords(t,function(t,e){n._data.putRange(e,!0),n._active=!t,n._eof=e&&e.length<(n._opts.limit||30),o(t,e)})};t.prototype.open=function(){var t={key:this.table()},e=this;return new Promise(function(o,r){OjsUtils.cloneProperties(e._opts,t),n.call(e,t,function(t,e){if(t)return void r(t);o(e)})})},t.prototype.next=function(){if(!this._active)throw"Invalid operation on closed dataset";this._opts.limit&&!isNaN(this._opts.limit)||(this._opts.limit=30),e[this.table()]=++e[this.table()];var t=this,o=e[t.table()]*t._opts.limit,r={key:t.table(),skip:o};return new Promise(function(e,o){if(t.eof())return void e(t.data());OjsUtils.cloneProperties(t._opts,r),n.call(t,r,function(t,n){if(t)return void o(t);e(n)})})},t.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),e[this.table()]=0,this._active=!1,this},t.prototype.clear=function(){var t=this;return new Promise(function(n,o){function r(r){if(r)return void o(r);e[t.table()]=0,SimpleDataSet.prototype.clear.apply(t,arguments),n()}t.proxy().clear(t.table(),r)})},t.prototype.refresh=function(){var t=this;return new Promise(function(e,n){t._opts.sort&&t._data.orderBy(t._opts.sort),e()})},t.prototype.insert=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.insert.apply(this,arguments)},t.prototype.update=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.update.apply(this,arguments)},t.prototype.delete=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.delete.apply(this,arguments)};var o=function(t,e){var n=[];return t.forEach(function(t){t.op===e&&n.push(t.record)}),n};return t.prototype.post=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e,n,r,i=this,a=this.synchronizer();return new Promise(function(c,u){function s(o){if(o)return i.cancel(),void u(o);a&&!t&&a.writeData(i.table(),e,n,r),i.refresh().then(c,u),i._cleanCache()}if(!i._history.length)return void c();e=o(i._history,"insert"),n=o(i._history,"update"),r=o(i._history,"delete"),i.proxy().commit(i.table(),e,n,r,s)})},t.prototype.sync=function(){var t=this,e=this.synchronizer();return new Promise(function(n,o){if(!e)return void n();e.exec(t.table(),function(e,r,i){function a(e){s.indexOfKey("id",e.id)<0&&t.delete(e)}function c(e){p.indexOf(e.id)>-1&&t.delete(e)}if(e)return void o(e);if(r=r||[],i=i||[],!r.length&&!i.length)return void n([]);var u,s=new ArrayMap,f=new ArrayMap,p=i.map(function(t){return t.id});s.putRange(r),f.putRange(t.data()),u=i&&i instanceof Array?c:a,f.forEach(u),s.forEach(function(e){t.save(e)}),t.post(!0).then(function(){n(r)},function(t){o(t)})})})},t.prototype.fetch=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e=this;return new Promise(function(n,o){if(!e.count())return void n();e.proxy().fetch(e.table(),e,t,function(t){if(t)return void o(t);n()})})},t.prototype.eof=function(){return this._eof},t.prototype.active=function(){return this._active},t}();"object"==typeof module&&module.exports&&(module.exports.DataSet=DataSet);var DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1,RESTFUL:2,INDEXEDDB:3,WEBSOCKET:4}}();"object"==typeof module&&module.exports&&(module.exports.DbProxies=DbProxies);var DbProxy=function(){"use strict";function t(){}return t.prototype.createDatabase=function(t,e){"function"==typeof e&&e()},t.prototype.getRecords=function(t,e){"function"==typeof e&&e(null,[])},t.prototype.groupBy=function(t,e,n,o,r){"function"==typeof r&&r(null,[])},t.prototype.commit=function(t,e,n,o,r){"function"==typeof r&&r()},t.prototype.fetch=function(t,e,n){"function"==typeof n&&n()},t.prototype.clear=function(t,e){"function"==typeof e&&e()},t.dateParser=function(t,e){var n=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&n.exec(e)?new Date(e):e},t}();"object"==typeof module&&module.exports&&(module.exports.DbProxy=DbProxy);var LocalStorageProxy=function(){"use strict";function t(){DbProxy.apply(this,arguments)}var e=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],o=new ArrayMap;return n&&o.putRange(JSON.parse(n,DbProxy.dateParser)),o.length&&t.params?o.query(t.params):o},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var o=e(t);t.sort&&o.orderBy(t.sort),"function"==typeof n&&n(null,o)},t.prototype.query=function(t,n,o){o(null,e(t).query(n))},t.prototype.groupBy=function(t,n,o,r,i){i(null,e(t).groupBy(n,o,r))};var o=function(t,e){var n=t.indexOfKey("id",e.id);-1===n?t.push(e):t.splice(n,1,e)},r=function(t,e){var n="object"==typeof e?e.id:e,o=t.indexOfKey("id",n);t.splice(o,1)};return t.prototype.commit=function(t,i,a,c,u){var s,f=i.concat(a),p=f.length+c.length,l=e(t),d=u&&"function"==typeof u?u:function(){};if(0===p)return d();for(s=0;s<f.length;s++)o.call(this,l,f[s]);for(s=0;s<c.length;s++)r.call(this,l,c[s]);n(t,l,d)},t.prototype.clear=function(t,e){n(t,[],e)},t}();"object"==typeof module&&module.exports&&(module.exports.LocalStorageProxy=LocalStorageProxy);var SQLiteProxy=function(){"use strict";function t(t){function n(){o=window.sqlitePlugin?window.sqlitePlugin.openDatabase(t):window.openDatabase(t.name,"SQLite Database",t.version||"1.0",5242880)}var o=null;t.schema&&(e=t.schema),void 0!==window.cordova?document.addEventListener("deviceready",n):n(),this.getDb=function(){return o},DbProxy.apply(this,arguments)}var e={};t.prototype=Object.create(DbProxy.prototype),t.prototype.createDatabase=function(t){var n=this,o=t&&"function"==typeof t?t:function(){};n.getDb().transaction(function(t){function n(){0===--s&&o()}var r,i,a,c,u,s=Object.keys(e).length;for(a in e){r="";for(c in e[a])i=e[a][c],i.hasMany||(i.hasOne&&(i.type=e[i.hasOne].id.type),r+=[c,i.type,i.required?"NOT NULL":"",i.primaryKey?"PRIMARY KEY":"",","].join(" "));r=r.substr(0,r.length-1),u=["CREATE TABLE IF NOT EXISTS",a,"(",r,")"].join(" "),t.executeSql(u,[],n)}},function(t){o(t)})};var n=function(t,n){var o,r,i,a={};for(o in e[t])r=n[o],i=e[t][o],"date"!==i.type&&"datetime"!==i.type||(r=new Date(r)),a[o]=r;return a},o=function(t,n,o){var r=e[t][n],i=void 0===typeof o[n]?null:o[n];return r.hasOne&&o instanceof ChildRecord&&(i=o.master().id),i},r=function(t,e,o,r,i){var a,c,u,s=new ArrayMap;r.executeSql(e,o,function(e,o){for(c=o.rows.length,a=0;a<c;a++)u=n(t,o.rows.item(a)),s.push(u);"function"==typeof i&&i(null,s)},function(t,e){console.error(e.message),i(e)})},i=function(t){var e,n=[];for(e in t)n.push(e+" "+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,e){var n,o=this,a=t&&t.key?t.key:t,c=t&&t.sort?i(t.sort):"",u="WHERE ",s=[];if("object"==typeof t){if(s=["SELECT * FROM",t.key],t.params){for(n in t.params)u+=n+" = '"+t.params[n]+"'";s.push(u)}s.push(c),t.skip&&s.push("OFFSET "+t.skip),t.limit&&s.push("LIMIT "+t.limit)}else s=["SELECT * FROM",t];o.getDb().transaction(function(t){r(a,s.join(" "),[],t,e)})};var a=function(t,e){var n,o,r="";for(n in e)if("object"==typeof e[n])for(o in e[n])switch(o){case"$gt":r+=[n,">",e[n][o]].join(" ")+" AND ";break;case"$gte":r+=[n,">=",e[n][o]].join(" ")+" AND ";break;case"$lt":r+=[n,"<",e[n][o]].join(" ")+" AND ";break;case"$lte":r+=[n,"<=",e[n][o]].join(" ")+" AND ";break;case"$start":r+=[n," LIKE '",e[n][o],"%'"].join("")+" AND ";break;case"$end":r+=[n," LIKE '%",e[n][o],"'"].join("")+" AND ";break;case"$contain":r+=[n," LIKE '%",e[n][o],"%'"].join("")+" AND ";break;case"$in":r+=[n," IN (",e[n][o].join(","),")"].join("")+" AND ";break;default:r+=""}else r+=[n," = '",e[n],"'"].join("")+" AND ";return""===r?t:(r=r.trim().slice(0,-3),[t,"WHERE",r].join(" "))},c=function(t,e,n,o){var r,i,c,u=e&&e instanceof Array?e:[e],s=n.length?n.join(",")+", ":"",f=o&&"object"==typeof o?a("",o):"",p="";return u.forEach(function(t){for(r in t)break;switch(i=t[r],c=t.alias||i,r){case"$max":p+=["MAX(",i,")"," AS ",c].join("")+", ";break;case"$min":p+=["MIN(",i,")"," AS ",c].join("")+", ";break;case"$sum":p+=["SUM(",i,")"," AS ",c].join("")+", ";break;case"$avg":p+=["AVG(",i,")"," AS ",c].join("")+", ";break;case"$count":p+=["COUNT(",i,")"," AS ",c].join("")+", "}}),""===p?["SELECT * FROM",t].join(" "):(p=p.trim().slice(0,-1),p=["SELECT",s,p,"FROM",t,f].join(" "),""===s?p:p+" GROUP BY "+s.trim().slice(0,-1))};t.prototype.query=function(t,e,n){var o=this,i=e&&"object"==typeof e?e:{},c=["SELECT * FROM",t].join(" "),u=e&&"function"==typeof e?e():a(c,i);o.getDb().transaction(function(e){r(t,u,[],e,n)})},t.prototype.groupBy=function(t,e,n,o,r){var i,a,u=this,s=c(t,e,n,o),f=new ArrayMap;u.getDb().transaction(function(t){t.executeSql(s,[],function(t,e){for(a=e.rows.length,i=0;i<a;i++)f.push(e.rows.item(i));"function"==typeof r&&r(null,f)},function(t,e){console.error(e.message),r(e)})})};var u=function(t,n,o,r,i){function a(){function r(){u.update(f.hasMany,d,o,i)}function i(){u.delete(f.hasMany,h,o,c)}var a,f,p,l=new ArrayMap,d=new ArrayMap,h=new ArrayMap;for(a in n)(f=e[t][a])&&f.hasMany&&(p=n[a])instanceof SimpleDataSet&&(s++,l.putRange(p._inserteds),d.putRange(p._updateds),h.putRange(p._deleteds),p._cleanCache(),u.insert(f.hasMany,l,o,r));c()}function c(){0===--s&&i()}var u=this,s=1;r(t,n,o,a)},s=function(t,n){var r,i,a,c,u=[],s="",f="";for(r in e[t])(c=e[t][r])&&!c.hasMany&&void 0!==(a=o(t,r,n))&&(u.push(a),s+=r+",",f+="?,");return s=s.substr(0,s.length-1),f=f.substr(0,f.length-1),i=["INSERT INTO",t,"(",s,") VALUES (",f,")"].join(" "),{sql:i,params:u}},f=function(t,e,n,o){var r=s(t,e);n.executeSql(r.sql,r.params,o)};t.prototype.insert=function(t,e,n,o){var r=this,i=e.length,a=0;if(0===i)return o();for(;a<i;a++)!function(e,a){u.call(r,t,e,n,f,function(){a===i-1&&o()})}(e[a],a)};var p=function(t,n){var r,i,a,c,u=[],s="id = '"+n.id+"'",f="";for(i in e[t])c=e[t][i],"id"!=i&&c&&!c.hasMany&&(a=o(t,i,n),f+=i+" = ?,",u.push(a));return f=f.substr(0,f.length-1),r=["UPDATE",t,"SET",f,"WHERE",s].join(" "),{sql:r,params:u}},l=function(t,e,n,o){var r=p(t,e);n.executeSql(r.sql,r.params,o)};t.prototype.update=function(t,e,n,o){var r=this,i=e.length,a=0;if(0===i)return o();for(;a<i;a++)!function(e,a){u.call(r,t,e,n,l,function(){a===i-1&&o()})}(e[a],a)};var d=function(t,n,o,r){function i(){0===--f&&(a=["DELETE FROM ",t," WHERE id = '",s,"'"].join(""),o.executeSql(a,[],function(){r()}))}var a,c,u,s="object"==typeof n?n.id:n,f=1;for(c in n)(u=e[t][c])&&u.hasMany&&(f++,a=["DELETE FROM ",u.hasMany," WHERE ",u.foreignKey," = '",s,"'"].join(""),o.executeSql(a,[],i),n[c]instanceof SimpleDataSet&&n[c].clear());i()};t.prototype.delete=function(t,e,n,o){var r=this,i=e.length,a=0;if(0===i)return o();for(;a<i;a++)!function(e,a){d.call(r,t,e,n,function(){a===i-1&&o()})}(e[a],a)},t.prototype.commit=function(t,e,n,o,r){function i(r){function i(){a.update(t,n,r,u)}function u(){a.delete(t,o,r,c)}a.insert(t,e,r,i)}var a=this,c=r&&"function"==typeof r?r:function(){};if(!e.length&&!n.length&&!o.length)return c();a.getDb().transaction(i,function(t){console.error(t.message),c(t)})};var h=function(t,n,o,r){var i,a,c,u={params:{}},s=e[t][o];if(n[o]instanceof SimpleDataSet||!s||!s.hasMany)return r();u.key=s.hasMany,u.params[s.foreignKey]=n.id,this.getRecords(u,function(e,u){if(e)return r(e);for(n[o]=new SimpleDataSet(t),i=0,a=u.length;i<a;i++)c=new ChildRecord(n),OjsUtils.cloneProperties(u[i],c),n[o].data.push(c);r()})};return t.prototype.fetch=function(t,e,n,o){var r="function"==typeof o?o:function(){},i=e.data.length,a=this,c=0;if(0===i)return r();for(;c<i;c++)!function(e,o){h.call(a,t,e,n,function(t){o===i-1&&r(t)})}(e.data[c],c)},t.prototype.clear=function(t,n){function o(n){function o(){0===--c&&n.executeSql("DELETE FROM "+t,[],function(){a()})}for(i in e[t])e[t][i].hasMany&&(c++,r=["DELETE FROM ",e[t][i].hasMany].join(""),n.executeSql(r,[],o));o()}var r,i,a="function"==typeof n?n:function(){},c=1;this.getDb().transaction(o,a)},t}();"object"==typeof module&&module.exports&&(module.exports.SQLiteProxy=SQLiteProxy);var RestProxy=function(){"use strict";function t(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=e,DbProxy.apply(this,arguments)}var e=function(t){return JSON.stringify(t)},n=function(t){return"function"==typeof t?t():t},o=function(t,e,o,r,i){var a,c,u,s=new XMLHttpRequest;if(s.open(e,t,!0),s.onreadystatechange=function(){4===s.readyState&&(a=[200,201,204,304].indexOf(s.status)>-1?r:i)(s)},"object"==typeof o){u=o.data;for(c in o.headers)s.setRequestHeader(c,n(o.headers[c]))}s.send(u)},r=function(t,e,n){var r,i="object"==typeof t?t:{key:t},a=this.config.url+"/"+i.key+"?",c=new ArrayMap;if(i.params)for(r in i.params)a+=r+"="+("object"==typeof i.params[r]?JSON.stringify(i.params[r]):i.params[r])+"&";if(i.sort){a+="sort=";for(r in i.sort){a+=r+(i.sort[r]?" "+i.sort[r]:"")+"&";break}}i.skip&&(a+="skip="+i.skip+"&"),i.limit&&(a+="limit="+i.limit+"&"),a=a.slice(0,-1),o(a,"GET",this.config,function(t){c.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(c)},n)},i=function(t,e,n,r,i){var a=this.config.url+"/"+e,c=n.id,u={};"POST"===t&&this.autoPK&&delete n.id,"PUT"===t&&(a+="/"+n.id),u.data=this.serialize(n),n.id=c,this.config.headers&&(u.headers=this.config.headers),o(a,t,u,r,i)},a=function(t){var e;try{e=JSON.parse(t.responseText)}catch(n){e={message:t.responseText}}return e};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,e){r.call(this,t,function(t){e(null,t)},function(t){e(a(t),[])})},t.prototype.query=function(t,e,n){r.call(this,{key:t,params:e},function(t){n(null,t)},function(t){n(a(t),[])})},t.prototype.groupBy=function(t,e,n,o,r){this.query(t,e,function(t,e){if(t)return void r(t);var i=e.groupBy(n,o,{});r(null,i)})},t.prototype.insert=function(t,e,n){var o=this,r=e.length,c=0;if(0===r)return n();for(;c<r;c++)!function(e,c){i.call(o,"POST",t,e,function(i){var a=JSON.parse(i.responseText);o.autoPK&&a.id&&DbEvents.emit(t,{event:"key",data:{oldId:e.id,newId:a.id}}),c===r-1&&n(null,i)},function(t){n(a(t))})}(e[c],c)},t.prototype.update=function(t,e,n){var o=this,r=e.length,c=0;if(0===r)return n();for(;c<r;c++)!function(e,c){i.call(o,"PUT",t,e,function(t){c===r-1&&n(null,t)},function(t){n(a(t))})}(e[c],c)},t.prototype.delete=function(t,e,n){var r=this.config.url+"/"+t+"/",i={},c=e.length,u=0;if(0===c)return n();for(this.config.headers&&(i.headers=this.config.headers);u<c;u++)!function(t,e){var u=r+t.id;o(u,"DELETE",i,function(t){e===c-1&&n(null,t)},function(t){n(a(t))})}(e[u],u)},t.prototype.commit=function(t,e,n,o,r){function i(e){if(e)return s(e);c.update(t,n,a)}function a(e){if(e)return s(e);c.delete(t,o,s)}var c=this,u=e.length+n.length+o.length,s=r&&"function"==typeof r?r:function(){};if(0===u)return s();c.insert(t,e,i)},t}();"object"==typeof module&&module.exports&&(module.exports.RestProxy=RestProxy);var IndexedDbProxy=function(){"use strict";function t(t){e=t,window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,DbProxy.apply(this,arguments)}var e,n=null;t.prototype=Object.create(DbProxy.prototype),t.prototype.createDatabase=function(t){var o=window.indexedDB.open(e.name,e.version),r=t;o.onerror=function(t){r(t.target)},o.onsuccess=function(t){n=o.result,r()},o.onupgradeneeded=function(t){var n,o,r,i=t.target.result,a=e.schema;for(n in a){var c=i.createObjectStore(n,{keyPath:"id"});for(o in a[n])r=a[n][o],c.createIndex(o,o,{unique:!!r.unique})}}},t.prototype.getRecords=function(t,e){var o=n.transaction([t.key]).objectStore(t.key),r=o.openCursor(),i=t,a=e;r.onsuccess=function(t){var e=t.target.result,n=new ArrayMap;if(e)return n.put(e.value),void e.continue();i.sort&&n.orderBy(i.sort),a(null,n)},r.onerror=function(t){a(t.target)}},t.prototype.query=function(t,e,n){var o={key:t},r=n;this.getRecords(o,function(t,n){if(t)return void r(t);r(null,n.query(e))})},t.prototype.groupBy=function(t,e,n,o,r){var i={key:t},a=r;this.getRecords(i,function(t,r){if(t)return void a(t);a(null,r.groupBy(e,n,o))})};var o=function(t,e,o,r){var i=n.transaction([t],"readwrite"),a=i.objectStore(t),c=o;e.foreach(function(t){r(a,t)}),i.onsuccess=function(t){c()},i.onerror=function(t){c(t.target)}};return t.prototype.commit=function(t,e,n,r,i){function a(e){if(e)return f(e);o.call(u,t,n,c,function(t,e){t.put(e)})}function c(e){if(e)return f(e);o.call(u,t,r,f,function(t,e){t.delete(e.id)})}var u=this,s=e.length+n.length+r.length,f=i&&"function"==typeof i?i:function(){};if(0===s)return f();o.call(u,t,e,a,function(t,e){t.add(e)})},t.prototype.clear=function(t,e){var o,r=n.transaction([t],"readwrite").objectStore(t),i=e;o=r.clear(),o.onsuccess=function(t){i()},o.onerror=function(t){i(t.target)}},t}();"object"==typeof module&&module.exports&&(module.exports.IndexedDbProxy=IndexedDbProxy);var WebSocketProxy=function(){"use strict";function t(t){this.config=t,this.connected=!1,e=new WebSocket(t.url),e.onopen=o.bind(this),e.onclose=r.bind(this),e.onmessage=a.bind(this),e.onerror=i.bind(this),DbProxy.apply(this,arguments)}var e,n=new ArrayMap,o=function(){this.connected=!0},r=function(){this.connected=!1},i=function(t){var e=t?JSON.stringify(t):{message:"Socket Error"};throw JSON.stringify(e)},a=function(t){var e=JSON.parse(t,DbProxy.dateParser),n=e.event+e.model;u(n,e.data)},c=function(t,o){var r=t.event+t.model;n.put({key:r,callback:o}),e.send(JSON.stringify(t))},u=function(t,e){var o=n.indexOfKey("key",t);n[o].callback(null,e),n.splice(o,1)};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,e){if(!this.connected)throw"Socket is not connected";var n,o=Object.assign({},t);delete o.key,n={event:"READ",model:t.key,data:o},c(n,e)},t.prototype.query=function(t,e,n){if(!this.connected)throw"Socket is not connected";c({event:"READ",model:t,data:e},n)},t.prototype.groupBy=function(t,e,n,o,r){this.query(t,e,function(t,e){if(t)return void r(t);var i=e.groupBy(n,o,{});r(null,i)})},t.prototype.insert=function(t,e,n){if(!this.connected)throw"Socket is not connected";c({event:"CREATE",model:t,data:e},n)},t.prototype.update=function(t,e,n){if(!this.connected)throw"Socket is not connected";c({event:"UPDATE",model:t,data:e},n)},t.prototype.delete=function(t,e,n){if(!this.connected)throw"Socket is not connected";c({event:"DELETE",model:t,data:e},n)},t.prototype.commit=function(t,e,n,o,r){function i(e){if(e)return s(e);c.update(t,n,a)}function a(e){if(e)return s(e);c.delete(t,o,s)}var c=this,u=e.length+n.length+o.length,s=r&&"function"==typeof r?r:function(){};if(0===u)return s();c.insert(t,e,i)},t}();"object"==typeof module&&module.exports&&(module.exports.WebSocketProxy=WebSocketProxy);var DbSync=function(){"use strict";function t(){}var e={Insert:"inserted",Update:"updated",
Delete:"deleted"},n=function(t){return["sync_",t].join("")},o=function(t){var e=n(t),o=window.localStorage[e]||"{}";return JSON.parse(o,DbProxy.dateParser)},r=function(t,e){var o=n(t);window.localStorage[o]=JSON.stringify(e)},i=function(t,e){for(var n=new ArrayMap,o=t.concat(e||[]),r=0,i=o.length;r<i;r++)n.indexOfKey("id",o[r].id)<0&&n.put(o[r]);return n};return t.prototype.writeData=function(t,n,a,c){var u=o(t);n.length&&(u[e.Insert]=i(n,u[e.Insert])),a.length&&(u[e.Update]=i(a,u[e.Update])),c.length&&(u[e.Delete]=i(c,u[e.Delete])),r(t,u)},t.prototype.cleanData=function(t){r(t,{})},t.prototype.sendData=function(t,e,n,o,r){"function"==typeof r&&r()},t.prototype.getData=function(t,e){"function"==typeof e&&e(null,[],[])},t.prototype.exec=function(t,n){function r(e){if(e)return c(e);i.cleanData(t),i.getData(t,c)}var i=this,a=o(t),c=n||function(){};i.sendData(t,a[e.Insert]||[],a[e.Update]||[],a[e.Delete]||[],r)},t}();"object"==typeof module&&module.exports&&(module.exports.DbSync=DbSync);/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var DbFactory=function(){"use strict";function t(t,e,n){var o,r=n;if(this.proxy=function(){return o},this.synchronizer=function(){return r},t&&"object"==typeof t)return void(o=t);switch(t){case 0:o=new LocalStorageProxy;break;case 1:o=new SQLiteProxy(e);break;case 2:o=new RestProxy(e);break;case 3:o=new IndexedDbProxy(e);break;case 4:o=new WebSocketProxy(e);break;default:throw"Proxy not implemented"}}t.prototype.createDb=function(){var t=this;return new Promise(function(e,n){t.proxy().createDatabase(function(t){if(t)return void n(t);e()})})},t.prototype.query=function(t,e){var n=this;return new Promise(function(o,r){n.proxy().query(t,e,function(t,e){if(t)return void r(t);o(e)})})},t.prototype.groupBy=function(t,e,n,o){var r=this;return new Promise(function(i,a){r.proxy().groupBy(t,e,n,o,function(t,e){if(t)return void a(t);i(e)})})},t.prototype.dataset=function(t){return new DataSet(t,this.proxy(),this.synchronizer())};var e=function(t,e,n,o){var r=this;return new Promise(function(i,a){r.proxy().commit(t,e,n,o,function(t){if(t)return void a(t);i()})})};return t.prototype.insert=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,o,[],[])},t.prototype.update=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,[],o,[])},t.prototype.delete=function(t,n){var o=n instanceof Array?n:[n];return e.call(this,t,[],[],o)},t}(),ojsDb=DbFactory;"object"==typeof module&&module.exports&&(module.exports.DbFactory=DbFactory);