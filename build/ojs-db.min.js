/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var ArrayMap=function(t){"use strict";function e(){var t=[];return t=Array.apply(t,arguments)||t,t.__proto__=e.prototype,t.mapTable=function(t){return this.map(function(e){return e[t]})},t.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},t.put=function(t,e){var n=e||this.length;this[n]=t},t.putRange=function(t,e){var n,r,o=e&&"boolean"==typeof e?this.length:0;if(t)for(t instanceof Array||(t=[t]),r=0,n=t.length;r<n;r++)this.put(t[r],o+r)},t.query=function(t){var r=this,o=t&&"object"==typeof t?t:{},i=new e,a=function(t){return n.call(r,t,o)},s=t&&"function"==typeof t?t:a;return i.putRange(r.filter(s)),i},t.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},r=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(t<e)},o=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(e<t)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?o(t[e],i[e]):r(t[e],i[e]);break}a=0}return a}),this},t.groupBy=function(t,o,i){var a,s,c,u=this,f=new e,p=i&&"object"==typeof i?i:{},h=o.length,l={};return u.forEach(function(t){if(n.call(u,t,p)){for(s={},c=0;c<h;c++)s[o[c]]=t[o[c]];a=JSON.stringify(s),l[a]=l[a]||[],l[a].push(t)}}),f.putRange(Object.keys(l).map(function(e){return s=JSON.parse(e),r(l[e],t,s)})),f},t.compute=function(t){return r(this,t)},t}var n=function(t,e){var n,r,o,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){o=t[n].toString();for(r in e[n]){switch(r){case"$gt":i=t[n]>e[n][r];break;case"$gte":i=t[n]>=e[n][r];break;case"$lt":i=t[n]<e[n][r];break;case"$lte":i=t[n]<=e[n][r];break;case"$not":i=t[n]!=e[n][r];break;case"$start":i=0===o.lastIndexOf(e[n][r],0);break;case"$end":i=o.indexOf(e[n][r],o.length-e[n][r].length)!==-1;break;case"$contain":i=o.indexOf(e[n][r])>-1;break;case"$in":i=e[n][r].indexOf(t[n])>-1;break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},r=function(t,e,n){var r,o,i,a=e&&e instanceof Array?e:[e],s=n||{};return a.forEach(function(e){for(r in e)break;switch(o=e[r],i=e.alias||o,r){case"$max":t.sort(function(t,e){return e[o]-t[o]}),s[i]=t[0][o];break;case"$min":t.sort(function(t,e){return t[o]-e[o]}),s[i]=t[0][o];break;case"$sum":s[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":s[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),s[i]/=t.length;break;case"$count":s[i]=t.length}}),s};return t.ArrayMap=e,e.prototype=Object.create(Array.prototype),e}(this),OjsUtils=function(t){"use strict";var e=function(t){for(var e,n=new Array(t),r=0;r<t;r++)0===(3&r)&&(e=4294967296*Math.random()),n[r]=e>>>((3&r)<<3)&255;return n},n=function(t){function e(t){return i[t>>18&63]+i[t>>12&63]+i[t>>6&63]+i[63&t]}var n,r,o,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,s="";for(o=0,r=t.length-a;o<r;o+=3)n=(t[o]<<16)+(t[o+1]<<8)+t[o+2],s+=e(n);switch(a){case 1:n=t[t.length-1],s+=i[n>>2],s+=i[n<<4&63],s+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],s+=i[n>>10],s+=i[n>>4&63],s+=i[n<<2&63],s+="="}return s};return t.OjsUtils={newId:function(){var t=(new Date).getTime();return performance&&performance.now&&(t=parseInt(performance.now().toString().replace(".",""))),t},uuid:function(t){return n(e(Math.ceil(Math.max(8,2*t)))).replace(/[+\/]/g,"").slice(0,t)},cloneObject:function(t){var e,n,r;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?e=new ArrayMap:t instanceof SimpleDataSet?e=new SimpleDataSet:t instanceof ChildRecord&&(e=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(e=e||[],n=0,r=t.length;n<r;n++)e[n]=this.cloneObject(t[n]);return e}if("object"==typeof t){e=e||{};for(n in t)t.hasOwnProperty(n)&&(e[n]=this.cloneObject(t[n]));return e}return t},cloneProperties:function(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}},t.OjsUtils}(this),ojsUtils=OjsUtils,ChildRecord=function(t){"use strict";function e(t){this.master=function(){return t}}return t.ChildRecord=e,e}(this),EventEmitter=function(t){"use strict";function e(){var t={};this.topics=function(){return t}}return t.EventEmitter=e,e.prototype.on=function(t,e){var n=this.topics();n.hasOwnProperty(t)||(n[t]=[]);var r=n[t].push(e)-1;return{remove:function(){delete n[t][r]}}},e.prototype.emit=function(t,e){var n=this.topics();n.hasOwnProperty(t)&&n[t].forEach(function(t){t(void 0!==e?e:{})})},e}(this),SimplePromise=function(t){"use strict";function e(t){return new a(t)}function n(t){return t&&"function"==typeof t.then}function r(t){for(var r=new a,o=[].slice.call(arguments,0),i=[],s=function(t){i.push(t),o.length===i.length&&r.resolve(i)},c=function(t){r.reject(t)},u=0,f=o.length;u<f;u++){var p=o[u];n(p)?p.then(s,c).resolve():"function"==typeof p?e().then(p).then(s,c).resolve():e().then(function(){return p}).then(s,c).resolve()}return r}var o=Object.freeze||function(){},i=function(){};i.prototype.resolve,i.prototype.reject,i.prototype.then;var a=function(t){this.state_=a.State.UNRESOLVED,this.chain_=[],this.scope_=t||null};return a.prototype.state_,a.prototype.chain_,a.prototype.scope_,a.prototype.result_,a.prototype.then=function(t,e,n){return this.chain_.push([t||null,e||null,n||null]),this.state_!==a.State.UNRESOLVED&&this.fire_(),this},a.prototype.resolve=function(t){this.state_=a.State.RESOLVED,this.fire_(t)},a.prototype.reject=function(t){this.state_=a.State.REJECTED,this.fire_(t)},a.prototype.isResolved=function(){return this.state_===a.State.RESOLVED},a.prototype.isRejected=function(){return this.state_===a.State.REJECTED},a.prototype.next=function(t,e,n){var r=n||10,o=new a(this);return o.then(t,e),this.then(function(t){setTimeout(function(){o.resolve(t)},r)},function(t){setTimeout(function(){o.reject(t)},r)}),o},a.prototype.fire_=function(t){var e="undefined"!=typeof t?t:this.result_;for(this.result_=e;this.chain_.length;){var n=this.chain_.shift(),r=this.state_===a.State.REJECTED?n[1]:n[0];if(r)try{e=this.result_=r.call(this.scope_,e)}catch(t){this.state_=a.State.REJECTED,e=this.result_=t}}},a.State={UNRESOLVED:"unresolved",RESOLVED:"resolved",REJECTED:"rejected"},o(a.State),t.SimplePromise={defer:e,isPromise:n,when:r},t.SimplePromise}(this),SimpleDataSet=function(t){"use strict";function e(t){EventEmitter.apply(this);var e=t||"tableName";this._history=[],this.data=new ArrayMap,this.table=function(){return e}}t.SimpleDataSet=e,e.prototype=Object.create(EventEmitter.prototype),e.prototype._cleanCache=function(){this._history.length=0},e.prototype.getById=function(t){var e=this.data.indexOfKey("id",t);return this.data[e]};var n=function(t,e){var n,r,o={op:t,record:OjsUtils.cloneObject(e)};if(r=this._history.some(function(r,o){return n=o,r.op===t&&r.record.id===e.id}))return void this._history.splice(n,1,o);if(this._history.push(o),this.emit(this.table(),{event:t,data:e}),e instanceof ChildRecord){var i=[this.table(),".child"].join("");DbEvents.emit(i,{event:t,data:e})}};return e.prototype.insert=function(t){t.id||(t.id=OjsUtils.newId());var e=this.data.indexOfKey("id",t.id);return e===-1&&(this.data.push(t),n.call(this,"insert",t)),this},e.prototype.update=function(t){if(!t.id)return this;var e=this.data.indexOfKey("id",t.id);return e===-1?this:(n.call(this,"update",this.data[e]),this.data.splice(e,1,t),this)},e.prototype.save=function(t){return t?t.id&&this.getById(t.id)?this.update(t):this.insert(t):this},e.prototype.delete=function(t){if(!t.id)return this;var e=this.data.indexOfKey("id",t.id);return e>=0&&(n.call(this,"delete",this.data[e]),this.data.splice(e,1)),this},e.prototype.insertAll=function(t){var e=this;return t instanceof Array?(t.forEach(function(t){e.insert(t)}),e):e},e.prototype.clear=function(t){return this.data.length=0,this._cleanCache(),t&&this.emit(this.table(),{event:"clear",data:[]}),this},e.prototype.cancel=function(){if(this._history.length){for(var t,e,n=this,r=n._history.length-1;r>=0;r--)switch(t=n._history[r],e=n.data.indexOfKey("id",t.record.id),t.op){case"insert":n.data.splice(e,1);break;case"update":n.data.splice(e,1,t.record);break;case"delete":n.data.push(t.record)}this.emit(this.table(),{event:"cancel",data:this._history}),this._history.length=0}},e.prototype.count=function(){return this.data.length},e.prototype.item=function(t){return this.data[t]},e.prototype.filter=function(t){return this.data.query(t)},e.prototype.forEach=function(t){this.data.forEach(t)},e.prototype.subscribe=function(t){return this.on(this.table(),t),this},e}(this),DataSet=function(t){"use strict";function e(t,e,r){SimpleDataSet.apply(this,[t]),n[t]=0,this._opts={},this._eof=!0,this._active=!1,this._reOpenOnRefresh=!1,this.proxy=function(){return e},this.synchronizer=function(){return r};var o=[t,".child"].join(""),i=this;DbEvents.on(o,function(t){i.save(t.data.master())})}var n={};t.DataSet=e,e.prototype=Object.create(SimpleDataSet.prototype),e.prototype.emit=function(t,e){DbEvents.emit(t,e)},e.prototype.subscribe=function(t){return DbEvents.on(this.table(),t),this},e.prototype.sort=function(t){return this._opts.sort=t,this},e.prototype.limit=function(t){return this._opts.limit=t,this},e.prototype.where=function(t){return this._opts.params=t,this},e.prototype.reOpenOnRefresh=function(t){return this._reOpenOnRefresh="true"===t.toString(),this};var r=function(t,e){var n=this,r=e&&"function"==typeof e?e:function(){};n.proxy().getRecords(t,function(t,e){n.data.putRange(e,!0),n._active=!t,n._eof=e&&e.length<(n._opts.limit||30),r(t,e),t||n.emit(n.table(),{event:"read",data:e})})};e.prototype.open=function(){var t={key:this.table()},e=SimplePromise.defer(),n=this;return n._active?(e.resolve(n),e):(OjsUtils.cloneProperties(n._opts,t),r.call(n,t,function(t,r){return t?void e.reject(t):void e.resolve(n)}),e)},e.prototype.next=function(){if(!this._active)throw"Invalid operation on closed dataset";this._opts.limit&&!isNaN(this._opts.limit)||(this._opts.limit=30),n[this.table()]=++n[this.table()];var t=this,e=n[t.table()]*t._opts.limit,o={key:t.table(),skip:e},i=SimplePromise.defer();return t.eof()?(i.resolve(t),i):(OjsUtils.cloneProperties(t._opts,o),r.call(t,o,function(e,n){return e?void i.reject(e):void i.resolve(t)}),i)},e.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),n[this.table()]=0,this._active=!1,this},e.prototype.clear=function(){function t(t){return t?void r.reject(t):(n[e.table()]=0,SimpleDataSet.prototype.clear.apply(e,arguments),void r.resolve(e))}var e=this,r=SimplePromise.defer();return e.proxy().clear(e.table(),t),r},e.prototype.refresh=function(){if(this._reOpenOnRefresh)return this._active=!1,this.open();var t=SimplePromise.defer();return this._opts.sort&&this.data.orderBy(this._opts.sort),t.resolve(this),t},e.prototype.insert=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.insert.apply(this,arguments)},e.prototype.update=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.update.apply(this,arguments)},e.prototype.delete=function(t){if(!this._active)throw"Invalid operation on closed dataset";SimpleDataSet.prototype.delete.apply(this,arguments)};var o=function(t,e){var n=[];return t.forEach(function(t){t.op===e&&n.push(t.record)}),n};return e.prototype.post=function(t){function e(e){return e?(a.cancel(),void c.reject(e)):(s&&!t&&s.writeData(a.table(),n,r,i),a.refresh().then(function(){c.resolve(!0)},function(t){c.reject(t)}),void a._cleanCache())}if(!this._active)throw"Invalid operation on closed dataset";var n,r,i,a=this,s=this.synchronizer(),c=SimplePromise.defer();return a._history.length?(n=o(a._history,"insert"),r=o(a._history,"update"),i=o(a._history,"delete"),a.proxy().commit(a.table(),n,r,i,e),c):(c.resolve(!0),c)},e.prototype.sync=function(){var t=this,e=this.synchronizer(),n=SimplePromise.defer();return e?(e.exec(t.table(),function(e,r,o){function i(e){c.indexOfKey("id",e.id)<0&&t.delete(e)}function a(e){f.indexOf(e.id)>-1&&t.delete(e)}if(e)return void n.reject(e);if(r=r||[],o=o||[],!r.length&&!o.length)return void n.resolve(t);var s,c=new ArrayMap,u=new ArrayMap,f=o.map(function(t){return t.id});c.putRange(r),u.putRange(t.data),s=o&&o instanceof Array?a:i,u.forEach(s),c.forEach(function(e){t.save(e)}),t.post(!0).then(function(){n.resolve(t)},function(t){n.reject(t)})}),n):(n.resolve(t),n)},e.prototype.fetch=function(t){if(!this._active)throw"Invalid operation on closed dataset";var e=SimplePromise.defer(),n=this;return this.count()?(this.proxy().fetch(this.table(),this,t,function(t){return t?void e.reject(t):void e.resolve(n)}),e):(e.resolve(n),e)},e.prototype.eof=function(){return this._eof},e.prototype.active=function(){return this._active},e}(this),DbProxies=function(t){return t.DbProxies={LOCALSTORAGE:0,SQLITE:1,RESTFUL:2},t.DbProxies}(this),DbProxy=function(t){function e(){}return t.DbProxy=e,e.prototype.createDatabase=function(t,e){"function"==typeof e&&e()},e.prototype.getRecords=function(t,e){"function"==typeof e&&e(null,[])},e.prototype.groupBy=function(t,e,n,r,o){"function"==typeof o&&o(null,[])},e.prototype.commit=function(t,e,n,r,o){"function"==typeof o&&o()},e.prototype.fetch=function(t,e,n){"function"==typeof n&&n()},e.prototype.clear=function(t,e){"function"==typeof e&&e()},e.dateParser=function(t,e){var n,r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&(n=r.exec(e))?new Date(e):e},e}(this),LocalStorageProxy=function(t){"use strict";function e(){DbProxy.apply(this,arguments)}var n=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],r=new ArrayMap;return n&&r.putRange(JSON.parse(n,DbProxy.dateParser)),r.length&&t.params?r.query(t.params):r},r=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.LocalStorageProxy=e,e.prototype=Object.create(DbProxy.prototype),e.prototype.getRecords=function(t,e){var r=n(t);t.sort&&r.orderBy(t.sort),"function"==typeof e&&e(null,r)},e.prototype.query=function(t,e,r){var o=n(t),i=o.query(e);r(null,i)},e.prototype.groupBy=function(t,e,r,o,i){var a=n(t);i(null,a.groupBy(e,r,o))},e.prototype.save=function(t,e,o){var i=n(t),a=i.indexOfKey("id",e.id);a===-1?i.push(e):i.splice(a,1,e),r(t,i,o)},e.prototype.remove=function(t,e,o){var i="object"==typeof e?e.id:e,a=n(t),s=a.indexOfKey("id",i);a.splice(s,1),r(t,a,o)},e.prototype.commit=function(t,e,n,r,o){function i(){u--,0===u&&f()}var a,s=this,c=e.concat(n),u=c.length+r.length,f=o&&"function"==typeof o?o:function(){};if(0===u)return f();for(a=0;a<c.length;a++)s.save(t,c[a],i);for(a=0;a<r.length;a++)s.remove(t,r[a],i)},e.prototype.clear=function(t,e){r(t,[],e)},e}(this),SQLiteProxy=function(t){"use strict";function e(t){function e(){n=window.sqlitePlugin?window.sqlitePlugin.openDatabase(t):window.openDatabase(t.name,"SQLite Database","1.0",5242880)}var n=null,r="undefined"!=typeof window.cordova;"object"==typeof t?t.location=t.location||"default":t.name=t,r?document.addEventListener("deviceready",e):e(),this.getDb=function(){return n},DbProxy.apply(this,arguments)}var n="SELECT * FROM",r={};t.SQLiteProxy=e,e.prototype=Object.create(DbProxy.prototype),e.prototype.createDatabase=function(t,e){var n=this;r=OjsUtils.cloneObject(t),n.getDb().transaction(function(t){function n(){f--,0===f&&u()}var o,i,a,s,c,u=e&&"function"==typeof e?e:function(){},f=Object.keys(r).length;for(a in r){o="";for(s in r[a])i=r[a][s],i.hasMany||(i.hasOne&&(i.type=r[i.hasOne].id.type),o+=[s,i.type,i.required?"NOT NULL":"",i.primaryKey?"PRIMARY KEY":"",","].join(" "));o=o.substr(0,o.length-1),c=["CREATE TABLE IF NOT EXISTS",a,"(",o,")"].join(" "),t.executeSql(c,[],n)}},function(t){cb(t)})};var o=function(t,e){var n,o,i,a={};for(n in r[t])o=e[n],i=r[t][n],"date"!==i.type&&"datetime"!==i.type||(o=new Date(o)),a[n]=o;return a},i=function(t,e,n){var o=r[t][e],i=void 0===typeof n[e]?null:n[e];return o.hasOne&&n instanceof ChildRecord&&(i=n.master().id),i},a=function(t,e,n,r,i){var a,s,c,u=new ArrayMap;r.executeSql(e,n,function(e,n){for(s=n.rows.length,a=0;a<s;a++)c=o(t,n.rows.item(a)),u.push(c);"function"==typeof i&&i(null,u)},function(t,e){console.error(e.message),i(e)})},s=function(t){var e,n=[];for(e in t)n.push(e+" "+t[e]);return"ORDER BY "+n.join(",")};e.prototype.getRecords=function(t,e){var r,o=this,i=t&&t.key?t.key:t,c=t&&t.sort?s(t.sort):"",u="WHERE ",f=[];if("object"==typeof t){if(f=[n,t.key],t.params){for(r in t.params)u+=r+" = '"+t.params[r]+"'";f.push(u)}f.push(c),t.skip&&f.push("OFFSET "+t.skip),t.limit&&f.push("LIMIT "+t.limit)}else f=[n,t];o.getDb().transaction(function(t){a(i,f.join(" "),[],t,e)})};var c=function(t,e){var n,r,o="";for(n in e)if("object"==typeof e[n])for(r in e[n])switch(r){case"$gt":o+=[n,">",e[n][r]].join(" ")+" AND ";break;case"$gte":o+=[n,">=",e[n][r]].join(" ")+" AND ";break;case"$lt":o+=[n,"<",e[n][r]].join(" ")+" AND ";break;case"$lte":o+=[n,"<=",e[n][r]].join(" ")+" AND ";break;case"$start":o+=[n," LIKE '",e[n][r],"%'"].join("")+" AND ";break;case"$end":o+=[n," LIKE '%",e[n][r],"'"].join("")+" AND ";break;case"$contain":o+=[n," LIKE '%",e[n][r],"%'"].join("")+" AND ";break;case"$in":o+=[n," IN (",e[n][r].join(","),")"].join("")+" AND ";break;default:o+=""}else o+=[n," = '",e[n],"'"].join("")+" AND ";return""===o?t:(o=o.trim().slice(0,-3),[t,"WHERE",o].join(" "))},u=function(t,e,r,o){var i,a,s,u=e&&e instanceof Array?e:[e],f=r.length?r.join(",")+", ":"",p=o&&"object"==typeof o?c("",o):"",h="";return u.forEach(function(t){for(i in t)break;switch(a=t[i],s=t.alias||a,i){case"$max":h+=["MAX(",a,")"," AS ",s].join("")+", ";break;case"$min":h+=["MIN(",a,")"," AS ",s].join("")+", ";break;case"$sum":h+=["SUM(",a,")"," AS ",s].join("")+", ";break;case"$avg":h+=["AVG(",a,")"," AS ",s].join("")+", ";break;case"$count":h+=["COUNT(",a,")"," AS ",s].join("")+", "}}),""===h?[n,t].join(" "):(h=h.trim().slice(0,-1),h=["SELECT",f,h,"FROM",t,p].join(" "),""===f?h:h+" GROUP BY "+f.trim().slice(0,-1))};e.prototype.query=function(t,e,r){var o=this,i=e&&"object"==typeof e?e:{},s=[n,t].join(" "),u=e&&"function"==typeof e?e():c(s,i);o.getDb().transaction(function(e){a(t,u,[],e,r)})},e.prototype.groupBy=function(t,e,n,r,o){var i,a,s=this,c=u(t,e,n,r),f=new ArrayMap;s.getDb().transaction(function(t){t.executeSql(c,[],function(t,e){for(a=e.rows.length,i=0;i<a;i++)f.push(e.rows.item(i));"function"==typeof o&&o(null,f)},function(t,e){console.error(e.message),o(e)})})};var f=function(t,e,n,o,i){function a(){function o(){c.update(f.hasMany,l,n,i)}function i(){c.delete(f.hasMany,y,n,s)}var a,f,p,h=new ArrayMap,l=new ArrayMap,y=new ArrayMap;for(a in e)f=r[t][a],f&&f.hasMany&&(p=e[a],p instanceof SimpleDataSet&&(u++,h.putRange(p._inserteds),l.putRange(p._updateds),y.putRange(p._deleteds),p._cleanCache(),c.insert(f.hasMany,h,n,o)));s()}function s(){u--,0===u&&i()}var c=this,u=1;o(t,e,n,a)},p=function(t,e){var n,o,a,s,c=[],u="",f="";for(n in r[t])s=r[t][n],s&&!s.hasMany&&(a=i(t,n,e),void 0!==a&&(c.push(a),u+=n+",",f+="?,"));return u=u.substr(0,u.length-1),f=f.substr(0,f.length-1),o=["INSERT INTO",t,"(",u,") VALUES (",f,")"].join(" "),{sql:o,params:c}},h=function(t,e,n,r){var o=p(t,e);n.executeSql(o.sql,o.params,r)};e.prototype.insert=function(t,e,n,r){function o(e,o){f.call(i,t,e,n,h,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;s<a;s++)o(e[s],s)};var l=function(t,e){var n,o,a,s,c=[],u="id = '"+e.id+"'",f="";for(o in r[t])s=r[t][o],"id"!=o&&s&&!s.hasMany&&(a=i(t,o,e),f+=o+" = ?,",c.push(a));return f=f.substr(0,f.length-1),n=["UPDATE",t,"SET",f,"WHERE",u].join(" "),{sql:n,params:c}},y=function(t,e,n,r){var o=l(t,e);n.executeSql(o.sql,o.params,r)};e.prototype.update=function(t,e,n,r){function o(e,o){f.call(i,t,e,n,y,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;s<a;s++)o(e[s],s)};var d=function(t,e,n,o){function i(){f--,0===f&&(a=["DELETE FROM ",t," WHERE id = '",u,"'"].join(""),n.executeSql(a,[],function(){o()}))}var a,s,c,u="object"==typeof e?e.id:e,f=1;for(s in e)c=r[t][s],c&&c.hasMany&&(f++,a=["DELETE FROM ",c.hasMany," WHERE ",c.foreignKey," = '",u,"'"].join(""),n.executeSql(a,[],i),e[s]instanceof SimpleDataSet&&e[s].clear());i()};e.prototype.delete=function(t,e,n,r){function o(e,o){d.call(i,t,e,n,function(){o===a-1&&r()})}var i=this,a=e.length,s=0;if(0===a)return r();for(;s<a;s++)o(e[s],s)},e.prototype.commit=function(t,e,n,r,o){function i(o){function i(){a.update(t,n,o,c)}function c(){a.delete(t,r,o,s)}a.insert(t,e,o,i)}var a=this,s=o&&"function"==typeof o?o:function(){};return e.length||n.length||r.length?void a.getDb().transaction(i,function(t){console.error(t.message),s(t)}):s()};var v=function(t,e,n,o){var i,a,s,c={params:{}},u=r[t][n];u&&u.hasMany?(c.key=u.hasMany,c.params[u.foreignKey]=e.id,this.getRecords(c,function(r,c){if(r)return o(r);for(e[n]=new SimpleDataSet(t),i=0,a=c.length;i<a;i++)s=new ChildRecord(e),OjsUtils.cloneProperties(c[i],s),e[n].data.push(s);o()})):o()};return e.prototype.fetch=function(t,e,n,r){function o(e,r){v.call(s,t,e,n,function(t){r===a-1&&i(t)})}var i="function"==typeof r?r:function(){},a=e.data.length,s=this,c=0;if(0===a)return i();for(;c<a;c++)o(e.data[c],c)},e.prototype.clear=function(t,e){function n(e){function n(){s--,0===s&&e.executeSql("DELETE FROM "+t,[],function(){a()})}for(i in r[t])r[t][i].hasMany&&(s++,o=["DELETE FROM ",r[t][i].hasMany].join(""),e.executeSql(o,[],n));n()}var o,i,a="function"==typeof e?e:function(){},s=1;this.getDb().transaction(n,a)},e}(this),RestProxy=function(t){"use strict";function e(t){var e;try{e=JSON.parse(t.responseText)}catch(n){e={error:t.responseText}}this.code=t.status,this.status=t.statusText,this.error=e.error||{}}function n(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=r,DbProxy.apply(this,arguments)}var r=function(t){return JSON.stringify(t)},o=function(t){var e="function"==typeof t?t():t;return e},i=function(t,e,n,r,i){var a,s,c,u=new XMLHttpRequest;if(u.open(e,t,!0),u.onreadystatechange=function(){4===u.readyState&&(a=[200,201,304].indexOf(u.status)>-1?r:i)(u)},"object"==typeof n){c=n.data;for(s in n.headers)u.setRequestHeader(s,o(n.headers[s]))}u.send(c)},a=function(t,e,n){var r,o="object"==typeof t?t:{key:t},a=this.config.url+"/"+o.key+"?",s=new ArrayMap;if(o.params)for(r in o.params)a+=r+"="+("object"==typeof o.params[r]?JSON.stringify(o.params[r]):o.params[r])+"&";if(o.sort){a+="sort=";for(r in o.sort){a+=r+(o.sort[r]?" "+o.sort[r]:"")+"&";break}}o.skip&&(a+="skip="+o.skip+"&"),o.limit&&(a+="limit="+o.limit+"&"),a=a.slice(0,-1),i(a,"GET",this.config,function(t){s.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(s)},n)},s=function(t,e,n,r,o){var a=this.config.url+"/"+e,s={};"POST"===t&&this.autoPK&&delete n.id,"PUT"===t&&(a+="/"+n.id),s.data=this.serialize(n),this.config.headers&&(s.headers=this.config.headers),i(a,t,s,r,o)};return t.RestProxy=n,n.prototype=Object.create(DbProxy.prototype),n.prototype.getRecords=function(t,n){a.call(this,t,function(t){n(null,t)},function(t){n(new e(t),[])})},n.prototype.query=function(t,n,r){var o={key:t,params:n};a.call(this,o,function(t){r(null,t)},function(t){r(new e(t),[])})},n.prototype.groupBy=function(t,e,n,r,o){this.query(t,e,function(t,e){if(t)return void o(t);var i=e.groupBy(n,r,{});o(null,i)})},n.prototype.insert=function(t,n,r){function o(e,o){s.call(a,"POST",t,e,function(t){var e=JSON.parse(t.responseText);a.autoPK&&e.id&&(n.id=e.id),o===c-1&&r(null,t)},i)}function i(t){r(new e(t))}var a=this,c=n.length,u=0;if(0===c)return r();for(;u<c;u++)o(n[u],u)},n.prototype.update=function(t,n,r){function o(e,n){s.call(a,"PUT",t,e,function(t){n===c-1&&r(null,t)},i)}function i(t){r(new e(t))}var a=this,c=n.length,u=0;if(0===c)return r();for(;u<c;u++)o(n[u],u)},n.prototype.delete=function(t,n,r){function o(t,e){var n=s+t.id;i(n,"DELETE",c,function(t){e===u-1&&r(null,t)},a)}function a(t){r(new e(t))}var s=this.config.url+"/"+t+"/",c={},u=n.length,f=0;if(0===u)return r();for(this.config.headers&&(c.headers=this.config.headers);f<u;f++)o(n[f],f)},n.prototype.commit=function(t,e,n,r,o){function i(e){return e?u(e):void s.update(t,n,a)}function a(e){return e?u(e):void s.delete(t,r,u)}var s=this,c=e.length+n.length+r.length,u=o&&"function"==typeof o?o:function(){};return 0===c?u():void s.insert(t,e,i)},n}(this),DbSync=function(t){"use strict";function e(){}var n={Insert:"inserted",Update:"updated",Delete:"deleted"};t.DbSync=e;var r=function(t){return["sync_",t].join("")},o=function(t){var e=r(t),n=window.localStorage[e]||"{}";return JSON.parse(n,DbProxy.dateParser)},i=function(t,e){var n=r(t);window.localStorage[n]=JSON.stringify(e)},a=function(t,e){for(var n=new ArrayMap,r=t.concat(e),o=0,i=r.length;o<i;o++)n.indexOfKey("id",r[o].id)<0&&n.put(r[o]);return n};return e.prototype.writeData=function(t,e,r,s){var c=o(t);c[n.Insert]=a(e,c[n.Insert]),c[n.Update]=a(r,c[n.Update]),c[n.Delete]=a(s,c[n.Delete]),i(t,c)},e.prototype.cleanData=function(t){i(t,{})},e.prototype.sendData=function(t,e,n,r,o){"function"==typeof o&&o()},e.prototype.getData=function(t,e){"function"==typeof e&&e(null,[],[])},e.prototype.exec=function(t,e){function r(e){return e?s(e):(i.cleanData(t),void i.getData(t,s))}var i=this,a=o(t),s=e||function(){};i.sendData(t,a[n.Insert],a[n.Update],a[n.Delete],r)},e}(this),DbEvents=function(t){return t.DbEvents=new EventEmitter,t.DbEvents}(this),DbFactory=function(t){"use strict";function e(t,e,n){var r,o=n;if(this.proxy=function(){return r},this.synchronizer=function(){return o},t&&"object"==typeof t)return void(r=t);switch(t){case 0:r=new LocalStorageProxy;break;case 1:r=new SQLiteProxy(e);break;case 2:r=new RestProxy(e);break;default:throw"Proxy not implemented"}}t.DbFactory=e,e.prototype.createDb=function(t){var e=SimplePromise.defer();return this.proxy().createDatabase(t,function(t){return t?void e.reject(t):void e.resolve(!0)}),e},e.prototype.query=function(t,e){var n=SimplePromise.defer();return this.proxy().query(t,e,function(t,e){return t?void n.reject(t):void n.resolve(e)}),n},e.prototype.groupBy=function(t,e,n,r){var o=SimplePromise.defer();return this.proxy().groupBy(t,e,n,r,function(t,e){return t?void o.reject(t):void o.resolve(e)}),o},e.prototype.dataset=function(t){return new DataSet(t,this.proxy(),this.synchronizer())};var n=function(t,e,n,r){var o=SimplePromise.defer();return this.proxy().commit(t,e,n,r,function(t){return t?void o.reject(t):void o.resolve(!0)}),o};return e.prototype.insert=function(t,e){var r=e instanceof Array?e:[e];return n.call(this,t,r,[],[])},e.prototype.update=function(t,e){var r=e instanceof Array?e:[e];return n.call(this,t,[],r,[])},e.prototype.delete=function(t,e){var r=e instanceof Array?e:[e];return n.call(this,t,[],[],r)},e}(this),ojsDb=DbFactory;