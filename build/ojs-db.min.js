!function t(n,e,r){function o(a,c){if(!e[a]){if(!n[a]){var u="function"==typeof require&&require;if(!c&&u)return u(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var f=e[a]={exports:{}};n[a][0].call(f.exports,function(t){var e=n[a][1][t];return o(e?e:t)},f,f.exports,t,n,e,r)}return e[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(t,n,e){"use strict";function r(){}function o(t){try{return t.then}catch(t){return v=t,b}}function i(t,n){try{return t(n)}catch(t){return v=t,b}}function a(t,n,e){try{t(n,e)}catch(t){return v=t,b}}function c(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==r&&y(t,this)}function u(t,n,e){return new t.constructor(function(o,i){var a=new c(r);a.then(o,i),s(t,new h(n,e,a))})}function s(t,n){for(;3===t._37;)t=t._12;return 0===t._37?void t._59.push(n):void d(function(){var e=1===t._37?n.onFulfilled:n.onRejected;if(null===e)return void(1===t._37?f(n.promise,t._12):p(n.promise,t._12));var r=i(e,t._12);r===b?p(n.promise,v):f(n.promise,r)})}function f(t,n){if(n===t)return p(t,new TypeError("A promise cannot be resolved with itself."));if(n&&("object"==typeof n||"function"==typeof n)){var e=o(n);if(e===b)return p(t,v);if(e===t.then&&n instanceof c)return t._37=3,t._12=n,void l(t);if("function"==typeof e)return void y(e.bind(n),t)}t._37=1,t._12=n,l(t)}function p(t,n){t._37=2,t._12=n,l(t)}function l(t){for(var n=0;n<t._59.length;n++)s(t,t._59[n]);t._59=null}function h(t,n,e){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.promise=e}function y(t,n){var e=!1,r=a(t,function(t){e||(e=!0,f(n,t))},function(t){e||(e=!0,p(n,t))});e||r!==b||(e=!0,p(n,v))}var d=t("asap/raw"),v=null,b={};n.exports=c,c._99=r,c.prototype.then=function(t,n){if(this.constructor!==c)return u(this,t,n);var e=new c(r);return s(this,new h(t,n,e)),e}},{"asap/raw":4}],2:[function(t,n,e){"use strict";function r(t){var n=new o(o._99);return n._37=1,n._12=t,n}var o=t("./core.js");n.exports=o;var i=r(!0),a=r(!1),c=r(null),u=r(void 0),s=r(0),f=r("");o.resolve=function(t){if(t instanceof o)return t;if(null===t)return c;if(void 0===t)return u;if(t===!0)return i;if(t===!1)return a;if(0===t)return s;if(""===t)return f;if("object"==typeof t||"function"==typeof t)try{var n=t.then;if("function"==typeof n)return new o(n.bind(t))}catch(t){return new o(function(n,e){e(t)})}return r(t)},o.all=function(t){var n=Array.prototype.slice.call(t);return new o(function(t,e){function r(a,c){if(c&&("object"==typeof c||"function"==typeof c)){if(c instanceof o&&c.then===o.prototype.then){for(;3===c._37;)c=c._12;return 1===c._37?r(a,c._12):(2===c._37&&e(c._12),void c.then(function(t){r(a,t)},e))}var u=c.then;if("function"==typeof u){var s=new o(u.bind(c));return void s.then(function(t){r(a,t)},e)}}n[a]=c,0===--i&&t(n)}if(0===n.length)return t([]);for(var i=n.length,a=0;a<n.length;a++)r(a,n[a])})},o.reject=function(t){return new o(function(n,e){e(t)})},o.race=function(t){return new o(function(n,e){t.forEach(function(t){o.resolve(t).then(n,e)})})},o.prototype.catch=function(t){return this.then(null,t)}},{"./core.js":1}],3:[function(t,n,e){"use strict";function r(){if(u.length)throw u.shift()}function o(t){var n;n=c.length?c.pop():new i,n.task=t,a(n)}function i(){this.task=null}var a=t("./raw"),c=[],u=[],s=a.makeRequestCallFromTimer(r);n.exports=o,i.prototype.call=function(){try{this.task.call()}catch(t){o.onerror?o.onerror(t):(u.push(t),s())}finally{this.task=null,c[c.length]=this}}},{"./raw":4}],4:[function(t,n,e){(function(t){"use strict";function e(t){c.length||(a(),u=!0),c[c.length]=t}function r(){for(;s<c.length;){var t=s;if(s+=1,c[t].call(),s>f){for(var n=0,e=c.length-s;n<e;n++)c[n]=c[n+s];c.length-=s,s=0}}c.length=0,s=0,u=!1}function o(t){var n=1,e=new p(t),r=document.createTextNode("");return e.observe(r,{characterData:!0}),function(){n=-n,r.data=n}}function i(t){return function(){function n(){clearTimeout(e),clearInterval(r),t()}var e=setTimeout(n,0),r=setInterval(n,50)}}n.exports=e;var a,c=[],u=!1,s=0,f=1024,p=t.MutationObserver||t.WebKitMutationObserver;a="function"==typeof p?o(r):i(r),e.requestFlush=a,e.makeRequestCallFromTimer=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(t,n,e){"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,n){var e=arguments.length?this.then.apply(this,arguments):this;e.then(null,function(t){setTimeout(function(){throw t},0)})})},{}],6:[function(t,n,e){t("asap");"undefined"==typeof Promise&&(Promise=t("./lib/core.js"),t("./lib/es6-extensions.js")),t("./polyfill-done.js")},{"./lib/core.js":1,"./lib/es6-extensions.js":2,"./polyfill-done.js":5,asap:3}]},{},[6]);var ArrayMap=function(t){"use strict";function n(){var t=[];return t=Array.apply(t,arguments)||t,t.__proto__=n.prototype,t.mapTable=function(t){return this.map(function(n){return n[t]})},t.indexOfKey=function(t,n){return this.mapTable(t).indexOf(n)},t.put=function(t,n){var e=n||this.length;this[e]=t},t.putRange=function(t,n){var e,r,o=n&&"boolean"==typeof n?this.length:0;if(t)for(t instanceof Array||(t=[t]),r=0,e=t.length;r<e;r++)this.put(t[r],o+r)},t.query=function(t){var r=this,o=t&&"object"==typeof t?t:{},i=new n,a=function(t){return e.call(r,t,o)},c=t&&"function"==typeof t?t:a;return i.putRange(r.filter(c)),i},t.orderBy=function(t){var n,e=t&&"object"==typeof t?t:{},r=function(t,n){return"string"==typeof t?t.localeCompare(n):(t>n)-(t<n)},o=function(t,n){return"string"==typeof n?n.localeCompare(t):(n>t)-(n<t)};return this.sort(function(t,i){var a=0;for(n in e){if(t[n]!=i[n]){a="desc"===e[n]?o(t[n],i[n]):r(t[n],i[n]);break}a=0}return a}),this},t.groupBy=function(t,o,i){var a,c,u,s=this,f=new n,p=i&&"object"==typeof i?i:{},l=o.length,h={};return s.forEach(function(t){if(e.call(s,t,p)){for(c={},u=0;u<l;u++)c[o[u]]=t[o[u]];a=JSON.stringify(c),h[a]=h[a]||[],h[a].push(t)}}),f.putRange(Object.keys(h).map(function(n){return c=JSON.parse(n),r(h[n],t,c)})),f},t.compute=function(t){return r(this,t)},t}var e=function(t,n){var e,r,o,i=!0;for(e in n){if(!i)break;if("object"==typeof n[e]){o=t[e].toString();for(r in n[e]){switch(r){case"$gt":i=t[e]>n[e][r];break;case"$gte":i=t[e]>=n[e][r];break;case"$lt":i=t[e]<n[e][r];break;case"$lte":i=t[e]<=n[e][r];break;case"$not":i=t[e]!=n[e][r];break;case"$start":i=0===o.lastIndexOf(n[e][r],0);break;case"$end":i=o.indexOf(n[e][r],o.length-n[e][r].length)!==-1;break;case"$contain":i=o.indexOf(n[e][r])>-1;break;case"$in":i=n[e][r].indexOf(t[e])>-1;break;default:i=!1}if(!i)break}}else i=t[e]==n[e]}return i},r=function(t,n,e){var r,o,i,a=n&&n instanceof Array?n:[n],c=e||{};return a.forEach(function(n){for(r in n)break;switch(o=n[r],i=n.alias||o,r){case"$max":t.sort(function(t,n){return n[o]-t[o]}),c[i]=t[0][o];break;case"$min":t.sort(function(t,n){return t[o]-n[o]}),c[i]=t[0][o];break;case"$sum":c[i]=t.map(function(t){return t[o]}).reduce(function(t,n){return parseFloat(t)+parseFloat(n)},0);break;case"$avg":c[i]=t.map(function(t){return t[o]}).reduce(function(t,n){return parseFloat(t)+parseFloat(n)},0),c[i]/=t.length;break;case"$count":c[i]=t.length}}),c};return t.ArrayMap=n,n.prototype=Object.create(Array.prototype),n}(this),OjsUtils=function(t){"use strict";var n=function(t){for(var n,e=new Array(t),r=0;r<t;r++)0===(3&r)&&(n=4294967296*Math.random()),e[r]=n>>>((3&r)<<3)&255;return e},e=function(t){function n(t){return i[t>>18&63]+i[t>>12&63]+i[t>>6&63]+i[63&t]}var e,r,o,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,c="";for(o=0,r=t.length-a;o<r;o+=3)e=(t[o]<<16)+(t[o+1]<<8)+t[o+2],c+=n(e);switch(a){case 1:e=t[t.length-1],c+=i[e>>2],c+=i[e<<4&63],c+="==";break;case 2:e=(t[t.length-2]<<8)+t[t.length-1],c+=i[e>>10],c+=i[e>>4&63],c+=i[e<<2&63],c+="="}return c};return t.OjsUtils={newId:function(){return Date.now()},uuid:function(t){return e(n(Math.ceil(Math.max(8,2*t)))).replace(/[+\/]/g,"").slice(0,t)},cloneObject:function(t){var n,e,r;if(!t||t instanceof Date)return t;if(t instanceof ArrayMap?n=new ArrayMap:t instanceof SimpleDataSet?n=new SimpleDataSet:t instanceof ChildRecord&&(n=new ChildRecord),"[object Array]"===Object.prototype.toString.call(t)){for(n=n||[],e=0,r=t.length;e<r;e++)n[e]=this.cloneObject(t[e]);return n}if("object"==typeof t){n=n||{};for(e in t)t.hasOwnProperty(e)&&(n[e]=this.cloneObject(t[e]));return n}return t},cloneProperties:function(t,n){for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e])}},t.OjsUtils}(this),ChildRecord=function(t){"use strict";function n(t){this.master=function(){return t}}return t.ChildRecord=n,n}(this),EventEmitter=function(t){"use strict";function n(){var t={};this.topics=function(){return t}}return t.EventEmitter=n,n.prototype.on=function(t,n){var e=this.topics();e.hasOwnProperty(t)||(e[t]=[]);var r=e[t].push(n)-1;return{remove:function(){delete e[t][r]}}},n.prototype.emit=function(t,n){var e=this.topics();e.hasOwnProperty(t)&&e[t].forEach(function(t){t(void 0!==n?n:{})})},n}(this),DbEvents=function(t){return t.DbEvents=new EventEmitter,t.DbEvents}(this),SimpleDataSet=function(t){"use strict";function n(t){EventEmitter.apply(this);var n=t||"tableName";this._history=[],this._data=new ArrayMap,this.table=function(){return n}}t.SimpleDataSet=n,n.prototype=Object.create(EventEmitter.prototype),n.prototype._cleanCache=function(){this._history.length=0},n.prototype.get=function(t){var n=this._data.indexOfKey("id",t);return this._data[n]};var e=function(t,n){var e,r,o={op:t,record:OjsUtils.cloneObject(n)};if(r=this._history.some(function(r,o){return e=o,r.op===t&&r.record.id===n.id}))return void this._history.splice(e,1,o);if(this._history.push(o),this.emit(this.table(),{event:t,data:n}),n instanceof ChildRecord){var i=[this.table(),".child"].join("");DbEvents.emit(i,{event:t,data:n})}};return n.prototype.insert=function(t){t.id||(t.id=OjsUtils.newId());var n=this._data.indexOfKey("id",t.id);return n===-1&&(this._data.push(t),e.call(this,"insert",t)),this},n.prototype.update=function(t){if(!t.id)return this;var n=this._data.indexOfKey("id",t.id);return n===-1?this:(e.call(this,"update",this._data[n]),this._data.splice(n,1,t),this)},n.prototype.save=function(t){return t?t.id&&this.get(t.id)?this.update(t):this.insert(t):this},n.prototype.delete=function(t){if(!t.id)return this;var n=this._data.indexOfKey("id",t.id);return n>=0&&(e.call(this,"delete",this._data[n]),this._data.splice(n,1)),this},n.prototype.insertAll=function(t){var n=this;return t instanceof Array?(t.forEach(function(t){n.insert(t)}),n):n},n.prototype.clear=function(t){return this._data.length=0,this._cleanCache(),t&&this.emit(this.table(),{event:"clear",data:[]}),this},n.prototype.cancel=function(){if(this._history.length){for(var t,n,e=this,r=e._history.length-1;r>=0;r--)switch(t=e._history[r],n=e._data.indexOfKey("id",t.record.id),t.op){case"insert":e._data.splice(n,1);break;case"update":e._data.splice(n,1,t.record);break;case"delete":e._data.push(t.record)}this.emit(this.table(),{event:"cancel",data:this._history}),this._history.length=0}},n.prototype.data=function(){return this._data},n.prototype.count=function(){return this._data.length},n.prototype.item=function(t){return this._data[t]},n.prototype.filter=function(t){return this._data.query(t)},n.prototype.forEach=function(t){this._data.forEach(t)},n.prototype.subscribe=function(t){return this.on(this.table(),t)},n}(this),DataSet=function(t){"use strict";function n(t,n,r){SimpleDataSet.apply(this,[t]),e[t]=0,this._opts={},this._eof=!0,this._active=!1,this._reOpenOnRefresh=!1,this.proxy=function(){return n},this.synchronizer=function(){return r};var o=[t,".child"].join(""),i=this;DbEvents.on(o,function(t){i.save(t.data.master())})}var e={};t.DataSet=n,n.prototype=Object.create(SimpleDataSet.prototype),n.prototype.emit=function(t,n){return DbEvents.emit(t,n),this},n.prototype.on=function(t,n){return DbEvents.on(t,n)},n.prototype.sort=function(t){return this._opts.sort=t,this},n.prototype.limit=function(t){return this._opts.limit=t,this},n.prototype.where=function(t){return this._opts.params=t,this},n.prototype.reOpenOnRefresh=function(t){return this._reOpenOnRefresh="true"===t.toString(),this};var r=function(t,n){var e=this,r=n&&"function"==typeof n?n:function(){};e.proxy().getRecords(t,function(t,n){e._data.putRange(n,!0),e._active=!t,e._eof=n&&n.length<(e._opts.limit||30),r(t,n),t||e.emit(e.table(),{event:"read",data:n})})};n.prototype.open=function(){var t={key:this.table()},n=this;return new Promise(function(e,o){return n._active?void e(n):(OjsUtils.cloneProperties(n._opts,t),void r.call(n,t,function(t,r){return t?void o(t):void e(n)}))})},n.prototype.next=function(){if(!this._active)throw"Invalid operation on closed dataset";this._opts.limit&&!isNaN(this._opts.limit)||(this._opts.limit=30),e[this.table()]=++e[this.table()];var t=this,n=e[t.table()]*t._opts.limit,o={key:t.table(),skip:n};return new Promise(function(n,e){return t.eof()?void n(t):(OjsUtils.cloneProperties(t._opts,o),void r.call(t,o,function(r,o){return r?void e(r):void n(t)}))})},n.prototype.close=function(){return SimpleDataSet.prototype.clear.apply(this,arguments),e[this.table()]=0,this._active=!1,this},n.prototype.clear=function(){var t=this;return new Promise(function(n,r){function o(o){return o?void r(o):(e[t.table()]=0,SimpleDataSet.prototype.clear.apply(t,arguments),void n(t))}t.proxy().clear(t.table(),o)})},n.prototype.refresh=function(){if(this._reOpenOnRefresh)return this._active=!1,this.open();var t=this;return new Promise(function(n,e){t._opts.sort&&t._data.orderBy(t._opts.sort),n(t)})},n.prototype.insert=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.insert.apply(this,arguments)},n.prototype.update=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.update.apply(this,arguments)},n.prototype.delete=function(t){if(!this._active)throw"Invalid operation on closed dataset";return SimpleDataSet.prototype.delete.apply(this,arguments)};var o=function(t,n){var e=[];return t.forEach(function(t){t.op===n&&e.push(t.record)}),e};return n.prototype.post=function(t){if(!this._active)throw"Invalid operation on closed dataset";var n,e,r,i=this,a=this.synchronizer();return new Promise(function(c,u){function s(o){return o?(i.cancel(),void u(o)):(a&&!t&&a.writeData(i.table(),n,e,r),i.refresh().then(function(){c()},function(t){u(t)}),void i._cleanCache())}return i._history.length?(n=o(i._history,"insert"),e=o(i._history,"update"),r=o(i._history,"delete"),void i.proxy().commit(i.table(),n,e,r,s)):void c()})},n.prototype.sync=function(){var t=this,n=this.synchronizer();return new Promise(function(e,r){return n?void n.exec(t.table(),function(n,o,i){function a(n){s.indexOfKey("id",n.id)<0&&t.delete(n)}function c(n){p.indexOf(n.id)>-1&&t.delete(n)}if(n)return void r(n);if(o=o||[],i=i||[],!o.length&&!i.length)return void e(t);var u,s=new ArrayMap,f=new ArrayMap,p=i.map(function(t){return t.id});s.putRange(o),f.putRange(t._data),u=i&&i instanceof Array?c:a,f.forEach(u),s.forEach(function(n){t.save(n)}),t.post(!0).then(function(){e(t)},function(t){r(t)})}):void e(t)})},n.prototype.fetch=function(t){if(!this._active)throw"Invalid operation on closed dataset";var n=this;return new Promise(function(e,r){return n.count()?void n.proxy().fetch(n.table(),n,t,function(t){return t?void r(t):void e(n)}):void e(n)})},n.prototype.eof=function(){return this._eof},n.prototype.active=function(){return this._active},n}(this),DbProxies=function(t){return t.DbProxies={LOCALSTORAGE:0,SQLITE:1,RESTFUL:2},t.DbProxies}(this),DbProxy=function(t){function n(){}return t.DbProxy=n,n.prototype.createDatabase=function(t,n){"function"==typeof n&&n()},n.prototype.getRecords=function(t,n){"function"==typeof n&&n(null,[])},n.prototype.groupBy=function(t,n,e,r,o){"function"==typeof o&&o(null,[])},n.prototype.commit=function(t,n,e,r,o){"function"==typeof o&&o()},n.prototype.fetch=function(t,n,e){"function"==typeof e&&e()},n.prototype.clear=function(t,n){"function"==typeof n&&n()},n.dateParser=function(t,n){var e,r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof n&&(e=r.exec(n))?new Date(n):n},n}(this),LocalStorageProxy=function(t){"use strict";function n(){DbProxy.apply(this,arguments)}var e=function(t){var n="object"==typeof t?t.key:t,e=window.localStorage[n],r=new ArrayMap;return e&&r.putRange(JSON.parse(e,DbProxy.dateParser)),r.length&&t.params?r.query(t.params):r},r=function(t,n,e){window.localStorage[t]=JSON.stringify(n),"function"==typeof e&&e()};t.LocalStorageProxy=n,n.prototype=Object.create(DbProxy.prototype),n.prototype.getRecords=function(t,n){var r=e(t);t.sort&&r.orderBy(t.sort),"function"==typeof n&&n(null,r)},n.prototype.query=function(t,n,r){var o=e(t),i=o.query(n);r(null,i)},n.prototype.groupBy=function(t,n,r,o,i){var a=e(t),c=a.groupBy(n,r,o);i(null,c)};var o=function(t,n){var e=t.indexOfKey("id",n.id);e===-1?t.push(n):t.splice(e,1,n)},i=function(t,n){var e="object"==typeof n?n.id:n,r=t.indexOfKey("id",e);t.splice(r,1)};return n.prototype.commit=function(t,n,a,c,u){var s,f=n.concat(a),p=f.length+c.length,l=e(t),h=u&&"function"==typeof u?u:function(){};if(0===p)return h();for(s=0;s<f.length;s++)o.call(this,l,f[s]);for(s=0;s<c.length;s++)i.call(this,l,c[s]);r(t,l,h)},n.prototype.clear=function(t,n){r(t,[],n)},n}(this),SQLiteProxy=function(t){"use strict";function n(t){function n(){e=window.sqlitePlugin?window.sqlitePlugin.openDatabase(r):window.openDatabase(r.name,"SQLite Database","1.0",5242880)}var e=null,r={},o="undefined"!=typeof window.cordova;"object"==typeof t?(r.name=t.name,r.location=t.location||"default"):r.name=t,o?document.addEventListener("deviceready",n):n(),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e="SELECT * FROM",r={};t.SQLiteProxy=n,n.prototype=Object.create(DbProxy.prototype),n.prototype.createDatabase=function(t,n){var e=this;r=OjsUtils.cloneObject(t),e.getDb().transaction(function(t){function e(){f--,0===f&&s()}var o,i,a,c,u,s=n&&"function"==typeof n?n:function(){},f=Object.keys(r).length;for(a in r){o="";for(c in r[a])i=r[a][c],i.hasMany||(i.hasOne&&(i.type=r[i.hasOne].id.type),o+=[c,i.type,i.required?"NOT NULL":"",i.primaryKey?"PRIMARY KEY":"",","].join(" "));o=o.substr(0,o.length-1),u=["CREATE TABLE IF NOT EXISTS",a,"(",o,")"].join(" "),t.executeSql(u,[],e)}},function(t){cb(t)})};var o=function(t,n){var e,o,i,a={};for(e in r[t])o=n[e],i=r[t][e],"date"!==i.type&&"datetime"!==i.type||(o=new Date(o)),a[e]=o;return a},i=function(t,n,e){var o=r[t][n],i=void 0===typeof e[n]?null:e[n];return o.hasOne&&e instanceof ChildRecord&&(i=e.master().id),i},a=function(t,n,e,r,i){var a,c,u,s=new ArrayMap;r.executeSql(n,e,function(n,e){for(c=e.rows.length,a=0;a<c;a++)u=o(t,e.rows.item(a)),s.push(u);"function"==typeof i&&i(null,s)},function(t,n){console.error(n.message),i(n)})},c=function(t){var n,e=[];for(n in t)e.push(n+" "+t[n]);return"ORDER BY "+e.join(",")};n.prototype.getRecords=function(t,n){var r,o=this,i=t&&t.key?t.key:t,u=t&&t.sort?c(t.sort):"",s="WHERE ",f=[];if("object"==typeof t){if(f=[e,t.key],t.params){for(r in t.params)s+=r+" = '"+t.params[r]+"'";f.push(s)}f.push(u),t.skip&&f.push("OFFSET "+t.skip),t.limit&&f.push("LIMIT "+t.limit)}else f=[e,t];o.getDb().transaction(function(t){a(i,f.join(" "),[],t,n)})};var u=function(t,n){var e,r,o="";for(e in n)if("object"==typeof n[e])for(r in n[e])switch(r){case"$gt":o+=[e,">",n[e][r]].join(" ")+" AND ";break;case"$gte":o+=[e,">=",n[e][r]].join(" ")+" AND ";break;case"$lt":o+=[e,"<",n[e][r]].join(" ")+" AND ";break;case"$lte":o+=[e,"<=",n[e][r]].join(" ")+" AND ";break;case"$start":o+=[e," LIKE '",n[e][r],"%'"].join("")+" AND ";break;case"$end":o+=[e," LIKE '%",n[e][r],"'"].join("")+" AND ";break;case"$contain":o+=[e," LIKE '%",n[e][r],"%'"].join("")+" AND ";break;case"$in":o+=[e," IN (",n[e][r].join(","),")"].join("")+" AND ";break;default:o+=""}else o+=[e," = '",n[e],"'"].join("")+" AND ";return""===o?t:(o=o.trim().slice(0,-3),[t,"WHERE",o].join(" "))},s=function(t,n,r,o){var i,a,c,s=n&&n instanceof Array?n:[n],f=r.length?r.join(",")+", ":"",p=o&&"object"==typeof o?u("",o):"",l="";return s.forEach(function(t){for(i in t)break;switch(a=t[i],c=t.alias||a,i){case"$max":l+=["MAX(",a,")"," AS ",c].join("")+", ";break;case"$min":l+=["MIN(",a,")"," AS ",c].join("")+", ";break;case"$sum":l+=["SUM(",a,")"," AS ",c].join("")+", ";break;case"$avg":l+=["AVG(",a,")"," AS ",c].join("")+", ";break;case"$count":l+=["COUNT(",a,")"," AS ",c].join("")+", "}}),""===l?[e,t].join(" "):(l=l.trim().slice(0,-1),l=["SELECT",f,l,"FROM",t,p].join(" "),""===f?l:l+" GROUP BY "+f.trim().slice(0,-1))};n.prototype.query=function(t,n,r){var o=this,i=n&&"object"==typeof n?n:{},c=[e,t].join(" "),s=n&&"function"==typeof n?n():u(c,i);o.getDb().transaction(function(n){a(t,s,[],n,r)})},n.prototype.groupBy=function(t,n,e,r,o){var i,a,c=this,u=s(t,n,e,r),f=new ArrayMap;c.getDb().transaction(function(t){t.executeSql(u,[],function(t,n){for(a=n.rows.length,i=0;i<a;i++)f.push(n.rows.item(i));"function"==typeof o&&o(null,f)},function(t,n){console.error(n.message),o(n)})})};var f=function(t,n,e,o,i){function a(){function o(){u.update(f.hasMany,h,e,i)}function i(){u.delete(f.hasMany,y,e,c)}var a,f,p,l=new ArrayMap,h=new ArrayMap,y=new ArrayMap;for(a in n)f=r[t][a],f&&f.hasMany&&(p=n[a],p instanceof SimpleDataSet&&(s++,l.putRange(p._inserteds),h.putRange(p._updateds),y.putRange(p._deleteds),p._cleanCache(),u.insert(f.hasMany,l,e,o)));c()}function c(){s--,0===s&&i()}var u=this,s=1;o(t,n,e,a)},p=function(t,n){var e,o,a,c,u=[],s="",f="";for(e in r[t])c=r[t][e],c&&!c.hasMany&&(a=i(t,e,n),void 0!==a&&(u.push(a),s+=e+",",f+="?,"));return s=s.substr(0,s.length-1),f=f.substr(0,f.length-1),o=["INSERT INTO",t,"(",s,") VALUES (",f,")"].join(" "),{sql:o,params:u}},l=function(t,n,e,r){var o=p(t,n);e.executeSql(o.sql,o.params,r)};n.prototype.insert=function(t,n,e,r){function o(n,o){f.call(i,t,n,e,l,function(){o===a-1&&r()})}var i=this,a=n.length,c=0;if(0===a)return r();for(;c<a;c++)o(n[c],c)};var h=function(t,n){var e,o,a,c,u=[],s="id = '"+n.id+"'",f="";for(o in r[t])c=r[t][o],"id"!=o&&c&&!c.hasMany&&(a=i(t,o,n),f+=o+" = ?,",u.push(a));return f=f.substr(0,f.length-1),e=["UPDATE",t,"SET",f,"WHERE",s].join(" "),{sql:e,params:u}},y=function(t,n,e,r){var o=h(t,n);e.executeSql(o.sql,o.params,r)};n.prototype.update=function(t,n,e,r){function o(n,o){f.call(i,t,n,e,y,function(){o===a-1&&r()})}var i=this,a=n.length,c=0;if(0===a)return r();for(;c<a;c++)o(n[c],c)};var d=function(t,n,e,o){function i(){f--,0===f&&(a=["DELETE FROM ",t," WHERE id = '",s,"'"].join(""),e.executeSql(a,[],function(){o()}))}var a,c,u,s="object"==typeof n?n.id:n,f=1;for(c in n)u=r[t][c],u&&u.hasMany&&(f++,a=["DELETE FROM ",u.hasMany," WHERE ",u.foreignKey," = '",s,"'"].join(""),e.executeSql(a,[],i),n[c]instanceof SimpleDataSet&&n[c].clear());i()};n.prototype.delete=function(t,n,e,r){function o(n,o){d.call(i,t,n,e,function(){o===a-1&&r()})}var i=this,a=n.length,c=0;if(0===a)return r();for(;c<a;c++)o(n[c],c)},n.prototype.commit=function(t,n,e,r,o){function i(o){function i(){a.update(t,e,o,u)}function u(){a.delete(t,r,o,c)}a.insert(t,n,o,i)}var a=this,c=o&&"function"==typeof o?o:function(){};return n.length||e.length||r.length?void a.getDb().transaction(i,function(t){console.error(t.message),c(t)}):c()};var v=function(t,n,e,o){var i,a,c,u={params:{}},s=r[t][e];return n[e]instanceof SimpleDataSet||!s||!s.hasMany?o():(u.key=s.hasMany,u.params[s.foreignKey]=n.id,void this.getRecords(u,function(r,u){if(r)return o(r);for(n[e]=new SimpleDataSet(t),i=0,a=u.length;i<a;i++)c=new ChildRecord(n),OjsUtils.cloneProperties(u[i],c),n[e].data.push(c);o()}))};return n.prototype.fetch=function(t,n,e,r){function o(n,r){v.call(c,t,n,e,function(t){r===a-1&&i(t)})}var i="function"==typeof r?r:function(){},a=n.data.length,c=this,u=0;if(0===a)return i();for(;u<a;u++)o(n.data[u],u)},n.prototype.clear=function(t,n){function e(n){function e(){c--,0===c&&n.executeSql("DELETE FROM "+t,[],function(){a()})}for(i in r[t])r[t][i].hasMany&&(c++,o=["DELETE FROM ",r[t][i].hasMany].join(""),n.executeSql(o,[],e));e()}var o,i,a="function"==typeof n?n:function(){},c=1;this.getDb().transaction(e,a)},n}(this),RestProxy=function(t){"use strict";function n(t){var n;try{n=JSON.parse(t.responseText)}catch(e){n={error:t.responseText}}this.code=t.status,this.status=t.statusText,this.error=n.error||{}}function e(t){this.config=t,t&&t.autoPK&&(this.autoPK=!0),t.serializeFn&&"function"==typeof t.serializeFn?this.serialize=t.serializeFn:this.serialize=r,DbProxy.apply(this,arguments)}var r=function(t){return JSON.stringify(t)},o=function(t){var n="function"==typeof t?t():t;return n},i=function(t,n,e,r,i){var a,c,u,s=new XMLHttpRequest;if(s.open(n,t,!0),s.onreadystatechange=function(){4===s.readyState&&(a=[200,201,304].indexOf(s.status)>-1?r:i)(s)},"object"==typeof e){u=e.data;for(c in e.headers)s.setRequestHeader(c,o(e.headers[c]))}s.send(u)},a=function(t,n,e){var r,o="object"==typeof t?t:{key:t},a=this.config.url+"/"+o.key+"?",c=new ArrayMap;if(o.params)for(r in o.params)a+=r+"="+("object"==typeof o.params[r]?JSON.stringify(o.params[r]):o.params[r])+"&";if(o.sort){a+="sort=";for(r in o.sort){a+=r+(o.sort[r]?" "+o.sort[r]:"")+"&";break}}o.skip&&(a+="skip="+o.skip+"&"),o.limit&&(a+="limit="+o.limit+"&"),a=a.slice(0,-1),i(a,"GET",this.config,function(t){c.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),n(c)},e)},c=function(t,n,e,r,o){var a=this.config.url+"/"+n,c={};"POST"===t&&this.autoPK&&delete e.id,"PUT"===t&&(a+="/"+e.id),c.data=this.serialize(e),this.config.headers&&(c.headers=this.config.headers),i(a,t,c,r,o)};return t.RestProxy=e,e.prototype=Object.create(DbProxy.prototype),e.prototype.getRecords=function(t,e){a.call(this,t,function(t){e(null,t)},function(t){e(new n(t),[])})},e.prototype.query=function(t,e,r){var o={key:t,params:e};a.call(this,o,function(t){r(null,t)},function(t){r(new n(t),[])})},e.prototype.groupBy=function(t,n,e,r,o){this.query(t,n,function(t,n){if(t)return void o(t);var i=n.groupBy(e,r,{});o(null,i)})},e.prototype.insert=function(t,e,r){function o(n,o){c.call(a,"POST",t,n,function(t){var n=JSON.parse(t.responseText);a.autoPK&&n.id&&(e.id=n.id),o===u-1&&r(null,t)},i)}function i(t){r(new n(t))}var a=this,u=e.length,s=0;if(0===u)return r();for(;s<u;s++)o(e[s],s)},e.prototype.update=function(t,e,r){function o(n,e){c.call(a,"PUT",t,n,function(t){e===u-1&&r(null,t)},i)}function i(t){r(new n(t))}var a=this,u=e.length,s=0;if(0===u)return r();for(;s<u;s++)o(e[s],s)},e.prototype.delete=function(t,e,r){function o(t,n){var e=c+t.id;i(e,"DELETE",u,function(t){n===s-1&&r(null,t)},a)}function a(t){r(new n(t))}var c=this.config.url+"/"+t+"/",u={},s=e.length,f=0;if(0===s)return r();for(this.config.headers&&(u.headers=this.config.headers);f<s;f++)o(e[f],f)},e.prototype.commit=function(t,n,e,r,o){function i(n){return n?s(n):void c.update(t,e,a)}function a(n){return n?s(n):void c.delete(t,r,s)}var c=this,u=n.length+e.length+r.length,s=o&&"function"==typeof o?o:function(){};return 0===u?s():void c.insert(t,n,i)},e}(this),DbSync=function(t){"use strict";function n(){}var e={Insert:"inserted",Update:"updated",Delete:"deleted"};t.DbSync=n;var r=function(t){return["sync_",t].join("")},o=function(t){var n=r(t),e=window.localStorage[n]||"{}";return JSON.parse(e,DbProxy.dateParser)},i=function(t,n){var e=r(t);window.localStorage[e]=JSON.stringify(n)},a=function(t,n){for(var e=new ArrayMap,r=t.concat(n||[]),o=0,i=r.length;o<i;o++)e.indexOfKey("id",r[o].id)<0&&e.put(r[o]);return e};return n.prototype.writeData=function(t,n,r,c){var u=o(t);n.length&&(u[e.Insert]=a(n,u[e.Insert])),r.length&&(u[e.Update]=a(r,u[e.Update])),c.length&&(u[e.Delete]=a(c,u[e.Delete])),i(t,u)},n.prototype.cleanData=function(t){i(t,{})},n.prototype.sendData=function(t,n,e,r,o){"function"==typeof o&&o()},n.prototype.getData=function(t,n){"function"==typeof n&&n(null,[],[])},n.prototype.exec=function(t,n){function r(n){return n?c(n):(i.cleanData(t),void i.getData(t,c))}var i=this,a=o(t),c=n||function(){};i.sendData(t,a[e.Insert]||[],a[e.Update]||[],a[e.Delete]||[],r)},n}(this),DbFactory=function(t){"use strict";function n(t,n,e){var r,o=e;if(this.proxy=function(){return r},this.synchronizer=function(){return o},t&&"object"==typeof t)return void(r=t);switch(t){case 0:r=new LocalStorageProxy;break;case 1:r=new SQLiteProxy(n);break;case 2:r=new RestProxy(n);break;default:throw"Proxy not implemented"}}t.DbFactory=n,n.prototype.createDb=function(t){var n=this;return new Promise(function(e,r){n.proxy().createDatabase(t,function(t){return t?void r(t):void e()})})},n.prototype.query=function(t,n){var e=this;return new Promise(function(r,o){e.proxy().query(t,n,function(t,n){return t?void o(t):void r(n)})})},n.prototype.groupBy=function(t,n,e,r){var o=this;return new Promise(function(i,a){o.proxy().groupBy(t,n,e,r,function(t,n){return t?void a(t):void i(n)})})},n.prototype.dataset=function(t){return new DataSet(t,this.proxy(),this.synchronizer())};var e=function(t,n,e,r){var o=this;return new Promise(function(i,a){o.proxy().commit(t,n,e,r,function(t){return t?void a(t):void i()})})};return n.prototype.insert=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,r,[],[])},n.prototype.update=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,[],r,[])},n.prototype.delete=function(t,n){var r=n instanceof Array?n:[n];return e.call(this,t,[],[],r)},n}(this),ojsDb=DbFactory;